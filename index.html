<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Signal Scanner Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --muted:#1e293b; --text:#e2e8f0;
    --chip:#0b2836; --ok:#0fbf5f; --warn:#f6c038; --bad:#ef4444; --link:#38bdf8;
  }
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";}
  body{margin:0;background:var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  h1{font-size:28px;margin:0 0 18px}
  .card{background:var(--panel);border-radius:12px;padding:16px;margin:14px 0;border:1px solid #0b2035}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{padding:8px 12px;border-radius:999px;background:#0d1b2a;color:#dbeafe;border:1px solid #20334b;cursor:pointer}
  .chip.active{outline:2px solid #2c7be5}
  .badge{font-size:12px;opacity:.8;margin-left:8px}
  .dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
  .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
  .btn{background:#0b2035;color:#e2e8f0;border:1px solid #1f3a58;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:12px 10px;border-bottom:1px solid #13243a;text-align:left}
  th{position:sticky;top:0;background:#0f1829;z-index:1}
  .pill{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #273c5b;display:inline-block}
  .pill.sell{background:#2a1014;color:#ffd0d4;border-color:#4e1f29}
  .pill.buy{background:#0d2617;color:#bff7d0;border-color:#1f5035}
  .pill.muted{background:#0f2031;color:#9fb3c8;border-color:#24364b}
  .toolbar{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .pager{display:flex;gap:8px;align-items:center}
  .pager input{width:64px;padding:6px 8px;background:#0b2035;border:1px solid #1f3a58;color:#e2e8f0;border-radius:8px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Signal Scanner Dashboard</h1>

    <!-- AUTO status -->
    <div class="card">
      <div class="row" id="autoStatusRow">
        <span class="chip"><span class="dot ok"></span>S&P 500</span>
        <span class="chip"><span class="dot ok"></span>Nasdaq 100</span>
        <span class="chip"><span class="dot ok"></span>Altcoins (OKX)</span>
        <span class="chip"><span class="dot ok"></span>Binance Top 200</span>
        <span class="chip"><span class="dot ok"></span>OKX Top 200</span>
        <span class="chip"><span class="dot ok"></span>Bitkub</span>
        <span class="chip"><span class="dot ok"></span>SET50</span>
        <span class="chip"><span class="dot ok"></span>SET100</span>
        <span class="chip"><span class="dot ok"></span>ETFs</span>
      </div>
      <div style="margin-top:8px;font-size:12px;opacity:.8">
        สถานะอัปเดต: <span id="lastAutoTs">-</span>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="saveBtn" disabled>บันทึกการตั้งค่า*</button>
        <span class="badge">* Auto-scan จะใส่คิวเป็น batch อัตโนมัติ</span>
      </div>
    </div>

    <!-- MANUAL -->
    <div class="card">
      <div class="row" id="manualGroups">
        <!-- เติมปุ่มด้วย JS -->
      </div>
      <div class="toolbar">
        <div>
          <span id="progressText">ยังไม่เริ่มสแกน</span>
        </div>
        <div>
          <span id="scanState"><span class="dot ok"></span> สแกนเสร็จแล้ว</span>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="card">
      <div class="toolbar">
        <div>
          กลุ่มล่าสุด: <b id="currentGroup">-</b>
          • อัปเดตเมื่อ: <span id="updatedAt">-</span>
        </div>
        <div class="pager">
          แถว/หน้า:
          <input type="number" id="pageSize" min="10" max="500" value="50"/>
          <button class="btn" id="prevBtn">ก่อนหน้า</button>
          <span id="pageInfo">หน้า 1/1</span>
          <button class="btn" id="nextBtn">ถัดไป</button>
          <button class="btn" id="refreshBtn">รีเฟรช</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:22%">Ticker</th>
            <th style="width:18%">Signal (1D)</th>
            <th style="width:18%">Signal (1W)</th>
            <th style="width:18%">Price</th>
            <th style="width:10%">Timeframe</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" style="opacity:.7">ไม่พบสัญญาณในรายการสแกนล่าสุด</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
const API_BASE = ""; // เรียก relative /api/...
const GROUPS = [
  ["sp500","S&P 500"],
  ["nasdaq100","Nasdaq 100"],
  ["altcoins","Altcoins (OKX)"],
  ["binance_top200","Binance Top 200"],
  ["okx_top200","OKX Top 200"],
  ["bitkub","Bitkub"],
  ["set50","SET50"],
  ["set100","SET100"],
  ["etfs","ETFs"],
  ["gold","ทองคำ"],
];

const manualWrap = document.getElementById("manualGroups");
GROUPS.forEach(([key,label])=>{
  const b = document.createElement("button");
  b.className = "chip";
  b.textContent = label;
  b.onclick = ()=> runFullScan(key, label);
  manualWrap.appendChild(b);
});

let tableState = { page:1, pageSize:50, data:[], group:"-", updatedAt:"-" };
document.getElementById("pageSize").addEventListener("change", (e)=>{
  tableState.pageSize = Math.max(10, parseInt(e.target.value||"50",10));
  renderTable();
});
document.getElementById("prevBtn").onclick = ()=>{ tableState.page=Math.max(1, tableState.page-1); renderTable(); };
document.getElementById("nextBtn").onclick = ()=>{ 
  const max = Math.max(1, Math.ceil(tableState.data.length / tableState.pageSize));
  tableState.page=Math.min(max, tableState.page+1); 
  renderTable(); 
};
document.getElementById("refreshBtn").onclick = ()=> fetchAndRenderLast();

function setProgress(msg, running=false){
  document.getElementById("progressText").textContent = msg;
  document.getElementById("scanState").innerHTML = running 
    ? '<span class="dot warn"></span> กำลังสแกน...'
    : '<span class="dot ok"></span> สแกนเสร็จแล้ว';
}

async function runFullScan(group, label){
  // ไฮไลต์ปุ่ม
  [...manualWrap.querySelectorAll(".chip")].forEach(el=>el.classList.remove("active"));
  event.currentTarget?.classList?.add("active");

  tableState.group = label;
  tableState.page = 1;
  setProgress("เริ่มสแกน...", true);

  // กำหนด batch ตามกลุ่ม
  let batchSize = 50;
  if (group==="sp500") batchSize = 100;
  if (group==="binance_top200" || group==="okx_top200") batchSize = 100;
  if (group==="bitkub") batchSize = 100;

  let cursor = 0, total = 0, processed = 0;
  while (true){
    const url = `${API_BASE}/api/run-scan?group=${encodeURIComponent(group)}&manual=1&cursor=${cursor}&batchSize=${batchSize}&live=1`;
    const r = await fetch(url);
    if (!r.ok){
      setProgress(`สั่งสแกนล้มเหลว: HTTP ${r.status}`, false);
      break;
    }
    const js = await r.json();
    total = js.total || total;
    processed += js.processed || 0;
    cursor = (js.nextCursor==null) ? null : js.nextCursor;

    const done = cursor==null;
    setProgress(`สแกนแล้ว: ${Math.min(processed,total)}/${total} – กลุ่ม: ${group}`, !done);

    // อัปเดตตารางด้วยผลสะสมล่าสุดที่ API คืน (savedPreview)
    const merged = js.savedPreview || {};
    if (merged?.results) {
      // จัด BUY มาก่อน (ถ้า 1D หรือ 1W เป็น Buy)
      const data = [...merged.results].sort((a,b)=>{
        const rank = v => v==="Buy" ? 2 : (v==="Sell" ? 1 : 0);
        const ra = Math.max(rank(a.signalD), rank(a.signalW));
        const rb = Math.max(rank(b.signalD), rank(b.signalW));
        if (rb!==ra) return rb-ra;
        return a.ticker.localeCompare(b.ticker);
      });
      tableState.data = data;
      tableState.updatedAt = merged.updatedAt || "-";
      tableState.group = label;
      renderTable();
    }
    if (done) break;
    // เว้นจังหวะเล็กน้อยกัน provider throttle
    await sleep(200);
  }
}

function pill(text, tone){
  const cls = tone==="buy" ? "pill buy" : tone==="sell" ? "pill sell" : "pill muted";
  return `<span class="${cls}">${text}</span>`;
}

function renderTable(){
  document.getElementById("currentGroup").textContent = tableState.group || "-";
  document.getElementById("updatedAt").textContent = tableState.updatedAt || "-";

  const tb = document.getElementById("tbody");
  tb.innerHTML = "";

  const n = tableState.data.length;
  if (!n){
    tb.innerHTML = `<tr><td colspan="5" style="opacity:.7">ไม่พบสัญญาณในรายการสแกนล่าสุด</td></tr>`;
    document.getElementById("pageInfo").textContent = "หน้า 1/1";
    return;
  }

  const max = Math.max(1, Math.ceil(n / tableState.pageSize));
  tableState.page = Math.min(tableState.page, max);
  const start = (tableState.page-1)*tableState.pageSize;
  const end = Math.min(start + tableState.pageSize, n);
  const rows = tableState.data.slice(start, end);

  for (const r of rows){
    const dTone = r.signalD==="Buy" ? "buy" : r.signalD==="Sell" ? "sell" : "muted";
    const wTone = r.signalW==="Buy" ? "buy" : r.signalW==="Sell" ? "sell" : "muted";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.ticker}</td>
      <td>${pill(r.signalD || "-", dTone)}</td>
      <td>${pill(r.signalW || "-", wTone)}</td>
      <td>${r.price==null ? "-" : r.price}</td>
      <td><span class="pill muted">${r.timeframe || "1D"}</span></td>
    `;
    tb.appendChild(tr);
  }
  document.getElementById("pageInfo").textContent = `หน้า ${tableState.page}/${max}`;
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
fetchAndRenderLast();
async function fetchAndRenderLast(){
  // อ่านไฟล์ signals.json ล่าสุดมาโชว์ (ถ้ามี)
  try{
    const qs = new URLSearchParams({ op:"read", path:"data/signals.json", repo:(window.NEXT_PUBLIC_REPO||""), branch:"main" });
    const r = await fetch(`${API_BASE}/api/github?${qs}`);
    if (!r.ok) return;
    const js = await r.json();
    if (js?.results){
      tableState.data = js.results;
      tableState.updatedAt = js.updatedAt || "-";
      renderTable();
    }
  }catch{}
}
</script>
</body>
</html>
