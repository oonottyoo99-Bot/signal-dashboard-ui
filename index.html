<!-- … ส่วนต้นไฟล์เหมือนเดิมของคุณ … -->

<script>
async function runScan(group, batchSize = 25) {
  try {
    setStatus(`กำลังสแกนกลุ่ม ${group}…`);
    let cursor = 0, total = 0, processed = 0;

    while (true) {
      const url = `/api/run-scan?group=${encodeURIComponent(group)}&manual=1&batchSize=${batchSize}&cursor=${cursor}`;
      const r = await fetch(url);
      const js = await r.json();

      if (!r.ok || js?.ok !== true) {
        const msg = js?.detail || js?.error || `HTTP ${r.status}`;
        throw new Error(msg);
      }

      total = js.total;
      processed = Math.max(processed, js.end + 1);
      renderProgress(group, processed, total);

      // อัปเดตตารางด้วยผลสะสมที่ API ส่งกลับมาให้ (savedPreview)
      if (js.savedPreview && js.savedPreview.group === group) {
        renderTable(js.savedPreview);
      }

      if (js.nextCursor == null) break;
      cursor = js.nextCursor;
      // ใส่ delay เล็กน้อยกัน rate-limit
      await sleep(350);
    }

    setStatus(`สแกนเสร็จแล้ว (${processed}/${total}) – กลุ่ม: ${group}`);
  } catch (err) {
    console.error(err);
    alert(`สั่งสแกนล้มเหลว: ${err.message || err}`);
    setStatus(`สั่งสแกนล้มเหลว: ${err.message || err}`);
  }
}
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
</script>
