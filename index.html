<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Signal Scanner Dashboard</title>

    <!-- Tailwind + React -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ฟอนต์ -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet"/>

    <style>
      body {
        font-family: 'Sarabun', sans-serif;
        background-color: #0a0a0a;
        background-image: radial-gradient(circle at 1px 1px, #333 1px, transparent 0);
        background-size: 25px 25px;
      }
      .gradient-text {
        background: linear-gradient(to right, #2dd4bf, #38bdf8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .scan-button { transition: all .2s ease-in-out; }
      .scan-button:disabled { cursor: not-allowed; filter: grayscale(80%); opacity: .5; }
      .scan-button:not(:disabled):hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,.2); }
      .loader { border-top-color: #fff; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  </head>

  <body class="text-gray-200">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // กลุ่มให้เลือกสแกน (ใช้ชื่อเป็นค่า group ใน /api/run-scan?group=...)
      const SCAN_GROUPS = [
        { id: 'sp500',      name: 'S&P 500',        cls: 'bg-blue-600 hover:bg-blue-500' },
        { id: 'nasdaq100',  name: 'Nasdaq 100',     cls: 'bg-indigo-600 hover:bg-indigo-500' },
        { id: 'altcoins',   name: 'Altcoins (OKX)', cls: 'bg-amber-600 hover:bg-amber-500' },
        { id: 'binance',    name: 'Binance Top 200',cls: 'bg-yellow-500 hover:bg-yellow-400 text-black' },
        { id: 'okx',        name: 'OKX Top 200',    cls: 'bg-cyan-600 hover:bg-cyan-500' },
        { id: 'bitkub',     name: 'Bitkub',         cls: 'bg-green-600 hover:bg-green-500' },
        { id: 'set50',      name: 'SET50',          cls: 'bg-emerald-600 hover:bg-emerald-500' },
        { id: 'set100',     name: 'SET100',         cls: 'bg-rose-600 hover:bg-rose-500' },
        { id: 'etf',        name: 'ETFs',           cls: 'bg-teal-600 hover:bg-teal-500' },
        { id: 'gold',       name: 'ทองคำ',          cls: 'bg-yellow-500 hover:bg-yellow-400 text-black' },
      ];

      function App() {
        const [signals, setSignals] = useState(null);
        const [loading, setLoading] = useState(false);
        const [scanning, setScanning] = useState(null);   // กำลังสแกนกลุ่มไหนอยู่

        // โหลดผลสแกนล่าสุดจาก /api/signals
        async function loadSignals() {
          setLoading(true);
          try {
            const r = await fetch('/api/signals', { cache: 'no-store' });
            const j = await r.json();
            setSignals(j);
          } catch (e) {
            console.error(e);
            alert('โหลดผลสแกนไม่สำเร็จ');
          } finally {
            setLoading(false);
          }
        }

        // กดสแกน Manual → /api/run-scan?group=xxx
        async function handleScan(groupId) {
          setScanning(groupId);
          try {
            await fetch(`/api/run-scan?group=${encodeURIComponent(groupId)}`, { cache: 'no-store' });

            // รอให้ API สุ่ม/คำนวณ แล้วค่อยโหลดผลใหม่
            setTimeout(loadSignals, 3000);
          } catch (e) {
            console.error(e);
            alert('สั่งสแกนไม่สำเร็จ');
          } finally {
            // ผ่อนเวลาโชว์สถานะกำลังสแกนนิดหนึ่ง
            setTimeout(() => setScanning(null), 5000);
          }
        }

        useEffect(() => { loadSignals(); }, []);

        return (
          <div className="container mx-auto p-4 md:p-8 max-w-7xl">
            {/* Header */}
            <header className="text-center mb-10">
              <h1 className="text-4xl md:text-5xl font-bold gradient-text">Signal Scanner Dashboard</h1>
              <p className="text-gray-400 mt-2">
                UI นี้เชื่อมกับ API บน Vercel: <code>/api/signals</code> และ <code>/api/run-scan</code>
              </p>
            </header>

            {/* Manual Scan */}
            <section className="bg-gray-800/50 backdrop-blur-sm border border-gray-700 p-6 rounded-xl shadow-lg mb-8">
              <h2 className="text-2xl font-semibold mb-4 text-gray-100">สั่งสแกนด้วยตนเอง (Manual Scan)</h2>
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                {SCAN_GROUPS.map(g => (
                  <button
                    key={g.id}
                    onClick={() => handleScan(g.id)}
                    disabled={!!scanning}
                    className={`scan-button text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center ${g.cls}`}
                  >
                    {scanning === g.id ? (
                      <div className="loader h-6 w-6 rounded-full border-2 border-t-2 border-gray-200/50"></div>
                    ) : (
                      <span>{g.name}</span>
                    )}
                  </button>
                ))}
              </div>
              {scanning && (
                <p className="text-center mt-4 text-amber-400 animate-pulse">
                  กำลังสั่งสแกนกลุ่ม <b>{scanning}</b> ...
                </p>
              )}
            </section>

            {/* ผลล่าสุด */}
            <section className="bg-gray-800/50 backdrop-blur-sm border border-gray-700 p-6 rounded-xl shadow-lg">
              <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <h2 className="text-2xl font-semibold text-gray-100">ผลการสแกนล่าสุด</h2>
                <button
                  onClick={loadSignals}
                  disabled={loading}
                  className="bg-gray-700 p-2 rounded-full hover:bg-gray-600 disabled:opacity-50"
                  title="รีเฟรชข้อมูล"
                >
                  {loading ? 'กำลังโหลด...' : 'รีโหลด'}
                </button>
              </div>

              {signals && !loading && (
                <div className="text-gray-400 mb-4 text-center md:text-left">
                  <p>
                    <strong>กลุ่มที่สแกนล่าสุด:</strong>{' '}
                    <span className="font-semibold text-amber-400">{signals.scan_group || '-'}</span>
                  </p>
                  <p>
                    <strong>อัปเดตเมื่อ:</strong> {signals.last_updated || '-'}
                  </p>
                </div>
              )}

              {loading && !signals && (
                <p className="text-center py-8">กำลังโหลดข้อมูล...</p>
              )}

              {signals && (
                <div className="overflow-x-auto">
                  <table className="min-w-full bg-gray-900/50 rounded-lg">
                    <thead className="bg-gray-700/50">
                      <tr>
                        <th className="py-3 px-4 text-left font-semibold">Ticker</th>
                        <th className="py-3 px-4 text-left font-semibold">Signal</th>
                        <th className="py-3 px-4 text-left font-semibold">Price</th>
                        <th className="py-3 px-4 text-left font-semibold hidden md:table-cell">Timeframe</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(signals.signals_found || []).length > 0 ? (
                        signals.signals_found.map((s, i) => (
                          <tr key={i} className="border-b border-gray-700 hover:bg-gray-700/50 transition-colors">
                            <td className="py-3 px-4 font-bold text-cyan-400">{s.ticker}</td>
                            <td className="py-3 px-4">
                              <span
                                className={
                                  'px-2.5 py-1 rounded-full text-xs font-semibold ' +
                                  (s.signal === 'Strong Buy'
                                    ? 'bg-green-500/20 text-green-300'
                                    : 'bg-yellow-500/20 text-yellow-300')
                                }
                              >
                                {s.signal}
                              </span>
                            </td>
                            <td className="py-3 px-4">{s.price}</td>
                            <td className="py-3 px-4 hidden md:table-cell">{s.timeframe}</td>
                          </tr>
                        ))
                      ) : (
                        <tr>
                          <td colSpan="4" className="text-center py-10 text-gray-500">
                            ไม่พบสัญญาณในรอบการสแกนล่าสุด
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              )}
            </section>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
