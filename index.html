<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signal Scanner Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:#e5e7eb; background:#0b0f14}
    .wrap{max-width:1100px; margin:32px auto; padding:0 16px}
    h1{color:#22d3ee; font-size:32px; margin:0 0 20px}
    .card{background:#10161d; border:1px solid #1f2937; border-radius:12px; padding:18px; margin:16px 0}
    .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
    .label{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid #273244; border-radius:8px; background:#0f1620}
    .btn{appearance:none; border:0; background:#16a34a; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn-alt{background:#334155}
    .btn-run{background:#0ea5e9}
    .section-title{font-size:18px; font-weight:700; margin-bottom:10px}
    table{width:100%; border-collapse:collapse; margin-top:10px; font-size:14px}
    th,td{padding:10px 12px; border-bottom:1px solid #1f2937}
    th{color:#93c5fd; text-align:left; background:#0f172a}
    .muted{color:#94a3b8; font-size:12px}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#1f2937}
    .right{margin-left:auto}
    .toast{position:fixed; right:16px; top:16px; background:#0b1220; color:#e5e7eb; border:1px solid #1e293b; border-radius:10px; padding:10px 14px; box-shadow:0 10px 20px rgba(0,0,0,.35); z-index:50}
    .warn{background:#7c2d12; border-color:#9a3412}
    .ok{background:#065f46; border-color:#0f766e}
    code{background:#0b1220; padding:2px 6px; border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Signal Scanner Dashboard</h1>

    <!-- Auto-Scan settings -->
    <div class="card">
      <div class="section-title">ตั้งค่าสแกนอัตโนมัติ (Auto-Scan)</div>
      <div class="row" id="auto-groups">
        <!-- กลุ่มที่รองรับ: ใช้ key ให้ตรงกับ data/symbols.json -->
        <label class="label"><input type="checkbox" data-auto-group="sp500"> S&amp;P 500</label>
        <label class="label"><input type="checkbox" data-auto-group="nasdaq100"> Nasdaq 100</label>
        <label class="label"><input type="checkbox" data-auto-group="altcoins"> Altcoins (OKX)</label>
        <label class="label"><input type="checkbox" data-auto-group="binance_top200"> Binance Top 200</label>
        <label class="label"><input type="checkbox" data-auto-group="okx_top200"> OKX Top 200</label>
        <label class="label"><input type="checkbox" data-auto-group="bitkub"> Bitkub</label>
        <label class="label"><input type="checkbox" data-auto-group="set50"> SET50</label>
        <label class="label"><input type="checkbox" data-auto-group="set100"> SET100</label>
        <label class="label"><input type="checkbox" data-auto-group="etf"> ETFs</label>
        <label class="label"><input type="checkbox" data-auto-group="gold"> ทองคำ</label>

        <button id="btn-save" class="btn right">บันทึกการตั้งค่า</button>
      </div>
      <div class="muted" style="margin-top:8px">
        ใช้ร่วมกับ Cron ได้ — ระบบจะสแกนเฉพาะกลุ่มที่เลือกไว้ในไฟล์ <code>data/settings.json</code>
      </div>
    </div>

    <!-- Manual Scan -->
    <div class="card">
      <div class="section-title">สั่งสแกนด้วยตนเอง (Manual Scan)</div>
      <div class="row">
        <button class="btn btn-run" data-run="sp500">S&amp;P 500</button>
        <button class="btn btn-run" data-run="nasdaq100">Nasdaq 100</button>
        <button class="btn btn-run" data-run="altcoins">Altcoins (OKX)</button>
        <button class="btn btn-run" data-run="binance_top200">Binance Top 200</button>
        <button class="btn btn-run" data-run="okx_top200">OKX Top 200</button>
        <button class="btn btn-run" data-run="bitkub">Bitkub</button>
        <button class="btn btn-run" data-run="set50">SET50</button>
        <button class="btn btn-run" data-run="set100">SET100</button>
        <button class="btn btn-run" data-run="etf">ETFs</button>
        <button class="btn btn-run" data-run="gold">ทองคำ</button>
      </div>
      <div id="manual-status" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- Latest results -->
    <div class="card">
      <div class="row">
        <div class="section-title">ผลการสแกนล่าสุด</div>
        <button id="btn-refresh" class="btn btn-alt right">รีเฟรช</button>
      </div>
      <div class="muted" id="meta"></div>
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:25%">Ticker</th>
            <th style="width:25%">Signal</th>
            <th style="width:25%">Price</th>
            <th style="width:25%">Timeframe</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="muted">ไม่มีข้อมูล</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="toast" style="display:none"></div>

  <script>
    const API_BASE = (window.NEXT_PUBLIC_API_BASE || location.origin).replace(/\/$/, "");

    // ---------- helpers ----------
    function showToast(msg, type="ok") {
      const el = document.getElementById("toast");
      el.className = "toast " + (type === "ok" ? "ok" : "warn");
      el.textContent = msg;
      el.style.display = "block";
      setTimeout(()=> el.style.display = "none", 2500);
    }
    function qsAll(sel){return Array.from(document.querySelectorAll(sel));}

    async function apiGet(path) {
      const r = await fetch(`${API_BASE}${path}`, { cache: 'no-store' });
      if (!r.ok) throw new Error(`${path} -> HTTP ${r.status}`);
      return await r.json();
    }
    async function apiPost(path, payload) {
      const r = await fetch(`${API_BASE}${path}`, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload || {})
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data?.error || r.statusText || `HTTP ${r.status}`);
      return data;
    }

    // ---------- settings ----------
    async function loadSettings() {
      try {
        const data = await apiGet('/api/settings');
        const selected = new Set(Array.isArray(data.auto_scan_groups) ? data.auto_scan_groups : []);
        qsAll('[data-auto-group]').forEach(cb => {
          cb.checked = selected.has(cb.getAttribute('data-auto-group'));
        });
      } catch (e) {
        showToast('อ่านการตั้งค่าไม่สำเร็จ: ' + e.message, 'warn');
      }
    }
    async function saveSettings() {
      const groups = qsAll('[data-auto-group]:checked').map(cb => cb.getAttribute('data-auto-group'));
      try {
        await apiPost('/api/settings', { auto_scan_groups: groups });
        showToast('บันทึกการตั้งค่าเรียบร้อย');
      } catch (e) {
        showToast('บันทึกไม่สำเร็จ: ' + e.message, 'warn');
      }
    }

    // ---------- manual scan ----------
    async function runManual(group) {
      const s = document.getElementById('manual-status');
      s.textContent = 'กำลังสแกนกลุ่ม ' + group + ' ...';
      try {
        const data = await apiGet(`/api/run-scan?group=${encodeURIComponent(group)}&manual=1`);
        s.textContent = 'สแกนเสร็จ: ' + group + ` (ได้ ${Array.isArray(data.results) ? data.results.length : 0} รายการ)`;
        await loadSignals(); // โหลดตารางล่าสุด
      } catch (e) {
        s.textContent = 'สแกนไม่สำเร็จ: ' + e.message;
      }
    }

    // ---------- latest signals table ----------
    function renderSignals(payload) {
      const tbody = document.getElementById('tbody');
      const meta = document.getElementById('meta');
      tbody.innerHTML = '';

      const group = payload?.group || '-';
      const updated = payload?.updatedAt ? new Date(payload.updatedAt).toLocaleString() : '-';
      meta.innerHTML = `กลุ่มล่าสุด: <span class="pill">${group}</span> &nbsp; อัปเดตเมื่อ: <span class="pill">${updated}</span>`;

      const list = Array.isArray(payload?.results) ? payload.results : [];
      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="muted">ไม่พบสัญญาณในรอบการสแกนล่าสุด</td></tr>`;
        return;
      }
      const fmt = (v) => (v==null ? '-' : v);
      list.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmt(row.ticker)}</td>
          <td>${fmt(row.signal)}</td>
          <td>${fmt(row.price)}</td>
          <td>${fmt(row.timeframe)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadSignals() {
      try {
        const data = await apiGet('/api/signals');
        renderSignals(data);
      } catch (e) {
        renderSignals({ group: '-', results: [] });
        showToast('อ่านผลล่าสุดไม่สำเร็จ: ' + e.message, 'warn');
      }
    }

    // ---------- wire up ----------
    document.getElementById('btn-save').addEventListener('click', saveSettings);
    document.getElementById('btn-refresh').addEventListener('click', loadSignals);
    qsAll('[data-run]').forEach(btn => btn.addEventListener('click', () => runManual(btn.getAttribute('data-run'))));

    // first load
    loadSettings();
    loadSignals();
  </script>
</body>
</html>
