<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signal Scanner Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0d10; --panel:#12161b; --chip:#0b2731; --chip-on:#0e6e84;
      --text:#cfe3ee; --muted:#99a3ad; --ok:#20c997; --warn:#ffc107; --danger:#ff4d4f;
      --link:#3fc3ff; --line:#1d2630;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0b0d10;color:var(--text);font:14px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1080px;margin:40px auto;padding:0 16px}
    h1{font-size:34px;letter-spacing:.5px;text-align:center;margin:0 0 24px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;margin:18px 0;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;height:36px;padding:0 12px;border-radius:999px;
      border:1px solid var(--chip);background:#0e1419;color:var(--text);cursor:pointer;user-select:none}
    .chip input{appearance:none;width:18px;height:18px;border-radius:4px;border:1px solid #355;display:inline-block;position:relative}
    .chip input:checked{background:var(--chip-on);border-color:var(--chip-on)}
    .chip input:checked::after{content:"";position:absolute;inset:4px;background:#fff;border-radius:2px}
    .btn{height:36px;border-radius:10px;border:1px solid #2a3946;background:#13202a;color:#bfe9ff;padding:0 14px;cursor:pointer}
    .btn.ok{background:#0e342a;border-color:#1f8f72;color:#b8ffe9}
    .btn.small{height:32px;font-size:12px}
    .toolbar{display:flex;gap:10px;align-items:center;margin-top:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    thead th{font-weight:600;text-align:left;padding:10px;border-bottom:1px solid var(--line);color:#99b2c6}
    tbody td{padding:12px 10px;border-bottom:1px dashed #17212c}
    .badge{display:inline-block;font-size:12px;padding:2px 10px;border-radius:999px;border:1px solid #344}
    .badge.sell{color:#ffc1c1;border-color:#593030;background:rgba(255,77,79,.12)}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .toast{position:fixed;right:16px;bottom:16px;background:#0f1b24;border:1px solid #274659;color:#d2f2ff;
      padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;transform:translateY(8px);transition:.25s}
    .toast.show{opacity:1;transform:none}
    a {color:var(--link);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Signal Scanner Dashboard</h1>

    <!-- Auto-scan -->
    <div class="card">
      <div class="row" style="margin-bottom:8px;font-weight:600">ตั้งค่าสแกนอัตโนมัติ (Auto-Scan)</div>
      <div class="row" id="auto-chips"></div>
      <div class="toolbar">
        <button id="btn-save" class="btn ok">บันทึกการตั้งค่า</button>
        <span id="save-state" class="muted"></span>
        <span class="right muted">* ถ้าเปิดหน้า preview แล้ว API ไม่มี ระบบจะสลับไปใช้ production ให้อัตโนมัติ</span>
      </div>
    </div>

    <!-- Manual -->
    <div class="card">
      <div class="row" style="margin-bottom:8px;font-weight:600">สั่งสแกนด้วยตนเอง (Manual Scan)</div>
      <div class="row" id="manual-buttons"></div>
      <div id="scan-note" class="muted" style="margin-top:6px"></div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="row" style="margin-bottom:6px;align-items:center">
        <div id="latest-title" class="muted">ผลการสแกนล่าสุด</div>
        <button id="btn-refresh" class="btn small right">รีเฟรช</button>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:20%">Ticker</th>
              <th style="width:20%">Signal</th>
              <th style="width:20%">Price</th>
              <th style="width:20%">Timeframe</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="4" class="muted">ไม่มีข้อมูล</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/** ----------------------------------------------------------------
 *  API base auto-detect:
 *  1) ลอง origin ปัจจุบัน (เช่น preview)
 *  2) ถ้าไม่ได้ → fallback ไป production
 * ---------------------------------------------------------------*/
const PROD = 'https://signal-dashboard-ui.vercel.app';
const API_CANDIDATES = [location.origin, PROD];

let API = PROD; // will be picked below

async function pickApiBase() {
  for (const base of API_CANDIDATES) {
    try {
      const ping = await fetch(base + '/api/github?op=ping', { cache: 'no-store' });
      if (ping.ok) { return base; }
    } catch (_) { /* ignore and try next */ }
  }
  return PROD;
}

/** UI helpers */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function toast(msg, ok=false){
  const t = $('#toast'); t.textContent = msg;
  t.style.borderColor = ok ? '#1f8f72' : '#6b2b2b';
  t.style.color = ok ? '#caffe6' : '#ffdede';
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 2200);
}

/** groups config (สอดคล้องกับ data/symbols.json) */
const GROUPS = [
  ['sp500','S&P 500'],
  ['nasdaq100','Nasdaq 100'],
  ['altcoins','Altcoins (OKX)'],
  ['binance_top200','Binance Top 200'],
  ['okx_top200','OKX Top 200'],
  ['bitkub','Bitkub'],
  ['set50','SET50'],
  ['set100','SET100'],
  ['etfs','ETFs'],
  ['gold','ทองคำ'],
];

function renderAutoChips(selected){
  const box = $('#auto-chips'); box.innerHTML = '';
  for (const [id,label] of GROUPS){
    const chip = document.createElement('label');
    chip.className = 'chip';
    chip.innerHTML = `<input type="checkbox" data-id="${id}" ${selected.includes(id)?'checked':''}/> ${label}`;
    box.appendChild(chip);
  }
}

function renderManualButtons(){
  const box = $('#manual-buttons'); box.innerHTML = '';
  for (const [id,label] of GROUPS){
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = label;
    btn.onclick = ()=> manualScan(id);
    box.appendChild(btn);
  }
}

function renderTable(payload){
  const tbody = $('#rows');
  const res = (payload && payload.results) || [];
  const title = `กลุ่มล่าสุด: ${payload?.group || '-'} • อัปเดตเมื่อ: ${payload?.updatedAt || '-'}`;
  $('#latest-title').textContent = title;

  if (!res.length){
    tbody.innerHTML = `<tr><td colspan="4" class="muted">ไม่มีข้อมูล</td></tr>`;
    return;
  }
  tbody.innerHTML = res.map(r=>`
    <tr>
      <td>${r.ticker}</td>
      <td><span class="badge sell">${r.signal || '-'}</span></td>
      <td>${r.price ?? '-'}</td>
      <td>${r.timeframe || '-'}</td>
    </tr>
  `).join('');
}

/** API calls */
async function loadSettings(){
  const r = await fetch(API + '/api/settings', { cache:'no-store' });
  if (!r.ok) throw new Error('settings HTTP '+r.status);
  return r.json();
}
async function saveSettings(){
  const groups = $$('#auto-chips input:checked').map(i=>i.dataset.id);
  const r = await fetch(API + '/api/settings', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ auto_scan_groups: groups })
  });
  if (!r.ok) throw new Error('save HTTP '+r.status);
  return r.json();
}
async function loadSignals(){
  const r = await fetch(API + '/api/signals', { cache:'no-store' });
  if (!r.ok) throw new Error('signals HTTP '+r.status);
  return r.json();
}
async function manualScan(group){
  $('#scan-note').textContent = `กำลังสั่งสแกนกลุ่ม ${group} ...`;
  try{
    const r = await fetch(API + `/api/run-scan?group=${encodeURIComponent(group)}&manual=1`, { cache:'no-store' });
    if (!r.ok) throw new Error('run-scan HTTP '+r.status);
    const json = await r.json();
    await refresh();
    toast('สแกนเสร็จแล้ว', true);
  }catch(err){
    toast('สั่งสแกนล้มเหลว: '+err.message);
  }finally{
    $('#scan-note').textContent = '';
  }
}
async function refresh(){
  try{
    const data = await loadSignals();
    renderTable(data);
  }catch(err){
    toast('โหลดผลล่าสุดล้มเหลว: '+err.message);
  }
}

/** boot */
(async function init(){
  API = await pickApiBase();
  renderManualButtons();

  try{
    const s = await loadSettings();
    renderAutoChips(s.auto_scan_groups || []);
  }catch{
    renderAutoChips([]); // เผื่อ settings ยังว่าง
  }
  await refresh();

  $('#btn-save').onclick = async ()=>{
    $('#save-state').textContent = 'กำลังบันทึก...';
    try{
      await saveSettings();
      $('#save-state').textContent = 'บันทึกแล้ว';
      toast('บันทึกการตั้งค่าเรียบร้อย', true);
    }catch(err){
      $('#save-state').textContent = '';
      toast('บันทึกไม่สำเร็จ: '+err.message);
    }
  };
  $('#btn-refresh').onclick = refresh;
})();
</script>
</body>
</html>
