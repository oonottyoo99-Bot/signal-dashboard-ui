<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Signal Scanner Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0d10; --panel:#12161b; --chip:#0b2731; --chip-on:#0e6e84;
  --ok:#20c997; --warn:#ffc107; --danger:#ff4d4f; --text:#e7eef5; --muted:#99a3ad;
}
*{box-sizing:border-box} body{margin:0;background:#0b0d10;color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial}
.wrap{max-width:1080px;margin:40px auto;padding:0 16px}
h1{font-weight:700;letter-spacing:.2px;text-align:center;margin:4px 0 24px}
.card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.btn{padding:10px 14px;border-radius:999px;background:#0f2330;border:1px solid rgba(255,255,255,.06);color:#cfe7f3;cursor:pointer}
.btn:hover{background:#143041}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.btn-primary{background:#0e6e84;border-color:transparent;color:#fff}
.btn-outline{background:transparent;border:1px solid rgba(255,255,255,.15)}
.kbd{font-size:12px;opacity:.7;border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:4px 7px}
.status{display:flex;align-items:center;gap:10px;font-size:14px;color:#cfe7f3;margin-top:8px}
.progress{height:8px;border-radius:8px;background:#1a2a36;overflow:hidden;flex:1}
.progress>span{display:block;height:8px;background:linear-gradient(90deg,#00b894,#20c997);width:0%}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:12px 10px;border-top:1px solid rgba(255,255,255,.06);text-align:left}
.badge{display:inline-block;padding:4px 9px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.1)}
.badge-sell{background:rgba(255,77,79,.1);color:#ff8082;border-color:rgba(255,77,79,.35)}
.badge-buy{background:rgba(32,201,151,.1);color:#67e5c1;border-color:rgba(32,201,151,.35)}
.badge-none{background:rgba(255,255,255,.04);color:#9fb4c3;border-color:rgba(255,255,255,.12)}
.chip-tf{font-size:11px;margin-left:6px;padding:3px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:#9fb4c3}
.chip-tf.on{background:rgba(32,201,151,.12);border-color:rgba(32,201,151,.35);color:#67e5c1}
.footer-note{font-size:12px;color:var(--muted);margin-top:8px}
.section-title{display:flex;align-items:center;justify-content:space-between;margin:6px 2px 10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Signal Scanner Dashboard</h1>

  <!-- Auto-Scan groups -->
  <div class="card" id="autoBox">
    <div class="row" id="autoGroups"></div>
    <div class="row" style="margin-top:10px">
      <button class="btn btn-primary" id="btnSaveAuto">บันทึกการตั้งค่า</button>
      <span class="footer-note">* Auto-scan จะใส่คิวเป็น batch อัตโนมัติ</span>
    </div>
  </div>

  <!-- Manual -->
  <div class="card" style="margin-top:14px">
    <div class="row" id="manualGroups"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn btn-outline" id="btnRefresh">รีเฟรช</button>
      <div class="status" id="scanStatus" style="display:none">
        <span id="scanLabel">กำลังสแกน…</span>
        <div class="progress"><span id="scanBar"></span></div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card" style="margin-top:14px">
    <div class="section-title">
      <div>
        <span>กลุ่มล่าสุด: <b id="lastGroup">-</b></span>
        <span class="kbd" id="lastUpdated">อัปเดตเมื่อ: -</span>
      </div>
      <button class="btn" id="btnReload">รีเฟรช</button>
    </div>
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Ticker</th>
          <th>Signal (1D)</th>
          <th>Signal (1W)</th>
          <th>Price</th>
          <th>Timeframe</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>
</div>

<script>
const API_BASE = (window.NEXT_PUBLIC_API_BASE)||location.origin;

const GROUPS = [
  {key:"sp500",        label:"S&P 500"},
  {key:"nasdaq100",    label:"Nasdaq 100"},
  {key:"altcoins",     label:"Altcoins (OKX)"},
  {key:"binance_top200", label:"Binance Top 200"},
  {key:"okx_top200",   label:"OKX Top 200"},
  {key:"bitkub",       label:"Bitkub"},
  {key:"set50",        label:"SET50"},
  {key:"set100",       label:"SET100"},
  {key:"etfs",         label:"ETFs"},
  {key:"gold",         label:"ทองคำ"},
];

let currentRunToken = 0; // ยกเลิกงานก่อนหน้าเมื่อสั่งใหม่
let runningGroup = null;

const elAuto = document.getElementById('autoGroups');
const elManual = document.getElementById('manualGroups');
const elSaveAuto = document.getElementById('btnSaveAuto');
const elRefresh = document.getElementById('btnRefresh');
const elReload = document.getElementById('btnReload');
const elTb = document.getElementById('tb');
const elLastGroup = document.getElementById('lastGroup');
const elUpdated = document.getElementById('lastUpdated');
const elStatus = document.getElementById('scanStatus');
const elLabel = document.getElementById('scanLabel');
const elBar = document.getElementById('scanBar');

init();

function init(){
  // ปุ่ม groups
  for(const g of GROUPS){
    const b1 = btn(g.label, ()=>toggleAuto(g.key)); b1.dataset.key=g.key; elAuto.appendChild(b1);
    const b2 = btn(g.label, ()=>manualScan(g.key)); b2.dataset.key=g.key; elManual.appendChild(b2);
  }
  elSaveAuto.onclick = saveAuto;
  elRefresh.onclick = ()=>loadSignals();
  elReload.onclick = ()=>loadSignals();
  loadAuto();
  loadSignals();
  restoreProgressBadges();
}

function btn(text, onclick){
  const b=document.createElement('button');
  b.className='btn';
  b.textContent=text;
  b.onclick=onclick;
  return b;
}

/* ------------------------ Auto-scan config ------------------------ */
async function loadAuto(){
  try{
    const r=await fetch(`${API_BASE}/api/settings`);
    const js=await r.json();
    const set=new Set(js?.auto_scan_groups||[]);
    for(const el of elAuto.querySelectorAll('button')){
      const key=el.dataset.key;
      markOn(el, set.has(key));
    }
  }catch(e){}
}
async function saveAuto(){
  const selected=[];
  for(const el of elAuto.querySelectorAll('button.on')) selected.push(el.dataset.key);
  try{
    const r=await fetch(`${API_BASE}/api/settings`,{
      method:"POST",headers:{'Content-Type':'application/json'},
      body:JSON.stringify({auto_scan_groups:selected})
    });
    if(!r.ok) throw new Error(await r.text());
    alert('บันทึกแล้ว');
  }catch(e){ alert('บันทึกไม่สำเร็จ: '+e.message); }
}
function toggleAuto(key){
  const el=[...elAuto.querySelectorAll('button')].find(x=>x.dataset.key===key);
  if(el) markOn(el, !el.classList.contains('on'));
}

/* ------------------------ Manual scan ------------------------ */
async function manualScan(group){
  // ยกเลิกงานก่อนหน้า
  currentRunToken++; 
  runningGroup = group;
  disableManual(true);

  // reset & show status
  showStatus(group,0,1,0);
  persistProgress(group,{progressText:'เริ่มสแกน…', x:0, y:0, pct:0});

  let cursor=0, total=null, token=currentRunToken;
  while(true){
    if(token!==currentRunToken) return; // ถูกยกเลิก
    try{
      const qs=new URLSearchParams({group, manual:1, cursor, batchSize:25}).toString();
      const r=await fetch(`${API_BASE}/api/run-scan?`+qs);
      const js=await r.json();
      if(!r.ok) throw new Error(js?.detail||r.statusText);

      total = js.total ?? total ?? 1;
      const end = (js.end ?? cursor-1) + 1;
      const processed = Math.min(end, total);
      const pct = Math.round(processed*100/total);

      // อัปเดตตารางจากผลสะสมล่าสุด (savedPreview)
      if(js.savedPreview) renderTable(js.savedPreview);

      showStatus(group, processed, total, pct);
      persistProgress(group, {progressText:`กำลังสแกน… (${processed}/${total})`, x:processed, y:total, pct});

      if(!js.nextCursor){ // จบแล้ว
        showStatusDone(group, processed, total);
        persistProgress(group, {progressText:`สแกนเสร็จแล้ว (${processed}/${total})`, x:processed, y:total, pct:100});
        break;
      }
      cursor = js.nextCursor;
    }catch(e){
      alert(`สั่งสแกนล้มเหลว: ${e.message}`);
      break;
    }
  }

  disableManual(false);
  runningGroup=null;
  loadSignals(); // เผื่อให้ชัวร์
}

/* ------------------------ UI helpers ------------------------ */
function disableManual(on){
  for(const el of elManual.querySelectorAll('button')) el.disabled=on && el.dataset.key!==runningGroup;
}
function markOn(el, on){ el.classList.toggle('on', !!on); if(on){el.style.background='#0e6e84';el.style.color='#fff'} else {el.style.background='#0f2330';el.style.color='#cfe7f3'} }

function showStatus(group, x, y, pct){
  elStatus.style.display='flex';
  elLabel.textContent = `กำลังสแกน… (${x}/${y} • ${pct}%) – กลุ่ม: ${group}`;
  elBar.style.width = `${pct}%`;
}
function showStatusDone(group, x, y){
  elStatus.style.display='flex';
  elLabel.textContent = `สแกนเสร็จแล้ว (${x}/${y}) – กลุ่ม: ${group}`;
  elBar.style.width = `100%`;
}
function hideStatus(){ elStatus.style.display='none'; elBar.style.width='0%' }

/* ------------------------ Table ------------------------ */
async function loadSignals(){
  try{
    const r=await fetch(`${API_BASE}/api/signals`);
    const js=await r.json();
    renderTable(js);
  }catch(e){}
}
function renderTable(sig){
  elLastGroup.textContent = sig?.group || '-';
  elUpdated.textContent   = `อัปเดตเมื่อ: ${sig?.updatedAt || '-'}`;
  const rows = (sig?.results||[]).map(r => rowHTML(r)).join('') || `<tr><td colspan="5" style="opacity:.7">ไม่พบสัญญาณในรอบการสแกนล่าสุด</td></tr>`;
  elTb.innerHTML = rows;
}
function rowHTML(r){
  const sD = badge(r.signalD);
  const sW = badgeW(r.signalW);
  const price = (r.price==null?'-':r.price);
  const tf = `1D <span class="chip-tf ${r.signalW&&r.signalW!=='-'?'on':''}">1W</span>`;
  return `<tr>
    <td>${esc(r.ticker)}</td>
    <td>${sD}</td>
    <td>${sW}</td>
    <td>${esc(price)}</td>
    <td>${tf}</td>
  </tr>`;
}
function badge(s){
  if(s==='Buy') return `<span class="badge badge-buy">Buy</span>`;
  if(s==='Sell') return `<span class="badge badge-sell">Sell</span>`;
  return `<span class="badge badge-none">-</span>`;
}
function badgeW(s){
  if(s==='Buy') return `<span class="badge badge-buy">Buy</span>`;
  if(s==='Sell') return `<span class="badge badge-sell">Sell</span>`;
  return `<span class="badge badge-none">-</span>`;
}
const esc = s => String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

/* ------------------------ Progress persistence ------------------------ */
function persistProgress(group, obj){
  const key=`progress:${group}`; localStorage.setItem(key, JSON.stringify(obj||{}));
  paintProgressBadge(group, obj);
}
function restoreProgressBadges(){
  for(const g of GROUPS){
    const key=`progress:${g.key}`;
    const data = safeJSON(localStorage.getItem(key));
    if(data) paintProgressBadge(g.key, data);
  }
}
function paintProgressBadge(group, data){
  const el=[...elManual.querySelectorAll('button')].find(x=>x.dataset.key===group);
  if(!el) return;
  el.querySelector('.kbd')?.remove();
  const pill=document.createElement('span'); pill.className='kbd'; pill.textContent=(data?.progressText||'');
  el.appendChild(pill);
}
function safeJSON(s){ try{return JSON.parse(s)}catch{return null} }
</script>
</body>
</html>
