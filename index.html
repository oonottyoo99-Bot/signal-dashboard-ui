<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Signal Scanner Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    :root{
      --bg:#0b0d10; --panel:#12161b; --text:#dfe7ef; --muted:#9aa3ad;
      --ok:#20c997; --warn:#ffc107; --danger:#ff5d5d; --chip:#0b2731; --chip-on:#0e6e84;
      --chip-buy:#0e6e2b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0b0d10;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:40px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 20px}
    .row{background:var(--panel);border-radius:14px;padding:16px 16px;margin:14px 0}
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:#0f1a22;color:#cfe4f5;border:1px solid #203040;border-radius:999px;padding:8px 14px;font-size:14px;cursor:pointer}
    .chip .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--ok);margin-right:8px;vertical-align:1px}
    .btn{background:#0d3b66;border:1px solid #1a4b77;color:#d9f0ff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .meta{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:12px 10px;border-bottom:1px solid #1e2a34}
    th{color:#9fb3c8;text-align:left;font-weight:600}
    .sig{display:inline-flex;gap:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid var(--chip-on);background:var(--chip);color:#bfe9ff}
    .badge.warn{border-color:#3a7a1e;background:#0f2a12;color:#aaf1a3}
    .badge.sell{border-color:#7a3a3a;background:#2a0f12;color:#f1aaaa}
    .badge.buy{border-color:#2a8f3a;background:#0f2a12;color:#a8f5b8}
    .kpi{font-size:13px;color:#9ab}
    .pill{border:1px solid #2a3b4a;background:#0c141b;padding:6px 10px;border-radius:999px;font-size:12px}
    .right{float:right}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Signal Scanner Dashboard</h1>

    <!-- แถวปุ่ม Auto + สถานะตลาด -->
    <div class="row">
      <div class="chips" id="auto-chips"></div>
      <div class="meta right" id="market-clock">สถานะอัปเดต: -</div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button class="btn" id="btnSave">บันทึกการตั้งค่า</button>
        <span class="meta">* Auto-scan จะใส่คิวเป็น batch อัตโนมัติ</span>
      </div>
    </div>

    <!-- แถว Manual Scan -->
    <div class="row">
      <div class="chips" id="manual-chips"></div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button class="btn" id="btnRefresh">รีเฟรช</button>
        <span class="kpi" id="scanStatus">สแกนแล้ว: -</span>
      </div>
    </div>

    <!-- ตารางผลลัพธ์ -->
    <div class="row">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div class="kpi">กลุ่มล่าสุด: <span id="latestGroup">-</span> • อัปเดตเมื่อ: <span id="latestTime">-</span></div>
        <button class="btn" id="btnReload">รีเฟรช</button>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:20%">Ticker</th>
            <th style="width:20%">Signal (1D)</th>
            <th style="width:20%">Signal (1W)</th>
            <th style="width:20%">Price</th>
            <th style="width:20%">Timeframe</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="5" class="meta">ไม่พบสัญญาณในรอบการสแกนล่าสุด</td></tr></tbody>
      </table>
    </div>
  </div>

<script>
const API = location.origin;
const GROUPS = [
  { key:"sp500",         label:"S&P 500",        tz:"America/New_York" },
  { key:"nasdaq100",     label:"Nasdaq 100",     tz:"America/New_York" },
  { key:"altcoins",      label:"Altcoins (OKX)", tz:"UTC" },
  { key:"binance_top200",label:"Binance Top 200",tz:"UTC" },
  { key:"okx_top200",    label:"OKX Top 200",    tz:"UTC" },
  { key:"bitkub",        label:"Bitkub",         tz:"Asia/Bangkok" },
  { key:"set50",         label:"SET50",          tz:"Asia/Bangkok" },
  { key:"set100",        label:"SET100",         tz:"Asia/Bangkok" },
  { key:"etfs",          label:"ETFs",           tz:"America/New_York" },
  { key:"gold",          label:"ทองคำ",          tz:"UTC" },
];

let manualGroup = "sp500";
let busy = false;

// สร้างชิปปุ่ม
function renderChips(containerId, onClick) {
  const el = document.getElementById(containerId);
  el.innerHTML = "";
  GROUPS.forEach(g => {
    const d = document.createElement("button");
    d.className = "chip";
    d.innerHTML = `<span class="dot"></span>${g.label} <span class="pill" id="pill-${g.key}">สแกนแล้ว (0/0)</span>`;
    d.onclick = () => onClick(g.key);
    el.appendChild(d);
  });
}

// อ่าน settings
async function getSettings(){
  const r = await fetch(`${API}/api/settings`);
  return r.json();
}

// เซฟ settings
document.getElementById("btnSave").onclick = async () => {
  const body = { auto_scan_groups: GROUPS.map(g=>g.key) }; // ตัวอย่าง: เลือกทุกกลุ่ม
  await fetch(`${API}/api/settings`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
  alert("บันทึกแล้ว");
};

// แสดงสถานะตลาดแบบคร่าว ๆ
function updateClock(){
  const now = new Date();
  document.getElementById("market-clock").textContent = `สถานะอัปเดต: ${now.toISOString()}`;
}
setInterval(updateClock, 30000); updateClock();

// Manual chips
renderChips("manual-chips", async (g) => {
  manualGroup = g;
  await runScanBatches(g);
});

// Auto chips (กดแล้วไม่สแกน แค่แสดงสถานะ)
renderChips("auto-chips", () => {});

// ดึง signals มาใส่ตาราง + จัดเรียงให้ BUY อยู่บนสุด
async function loadSignals(){
  const r = await fetch(`${API}/api/signals`);
  if(!r.ok) return;
  const js = await r.json();
  const group = js.group || "-";
  const t = js.updatedAt ? new Date(js.updatedAt).toISOString() : "-";
  document.getElementById("latestGroup").textContent = group;
  document.getElementById("latestTime").textContent = t;

  let rows = Array.isArray(js.results) ? js.results.slice() : [];

  // จัดเรียง: มี BUY (1D หรือ 1W) ก่อนเสมอ, จากนั้น Sell, จากนั้น "-"
  const rank = (d,w) => {
    if (String(d).toUpperCase()==="BUY" || String(w).toUpperCase()==="BUY") return 0;
    if (String(d).toUpperCase()==="SELL"|| String(w).toUpperCase()==="SELL") return 1;
    return 2;
  };
  rows.sort((a,b)=> rank(a.signalD,a.signalW) - rank(b.signalD,b.signalW));

  const tb = document.getElementById("rows");
  tb.innerHTML = "";
  if (!rows.length){
    tb.innerHTML = `<tr><td colspan="5" class="meta">ไม่พบสัญญาณในรอบการสแกนล่าสุด</td></tr>`;
    return;
  }
  for (const it of rows){
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${it.ticker||"-"}</td>
        <td><span class="sig">${
          it.signalD==="Buy"||it.signalD==="BUY" ? `<span class="badge buy">BUY</span>` :
          it.signalD==="Sell"||it.signalD==="SELL"? `<span class="badge sell">Sell</span>` :
          `<span class="badge">-</span>`
        }</span></td>
        <td><span class="sig">${
          it.signalW==="Buy"||it.signalW==="BUY" ? `<span class="badge warn">BUY</span>` :
          it.signalW==="Sell"||it.signalW==="SELL"? `<span class="badge sell">Sell</span>` :
          `<span class="badge">-</span>`
        }</span></td>
        <td>${it.price ?? "-"}</td>
        <td>${it.timeframe || "1D"}</td>
      </tr>
    `);
  }
}
document.getElementById("btnReload").onclick = loadSignals;
document.getElementById("btnRefresh").onclick = loadSignals;

// เรียกสแกนแบบ batch จนครบ total
async function runScanBatches(group){
  if (busy) return;
  busy = true;
  try{
    let cursor = 0, total = 0, done = 0, round = 0;
    while(true){
      const url = `${API}/api/run-scan?group=${encodeURIComponent(group)}&manual=1&cursor=${cursor}`;
      const r = await fetch(url);
      if(!r.ok){
        document.getElementById("scanStatus").textContent = `สั่งสแกนล้มเหลว: ${await r.text()}`;
        break;
      }
      const js = await r.json();
      total = js.total;
      done += js.processed;
      cursor = js.nextCursor ?? null;
      document.getElementById(`pill-${group}`).textContent = `สแกนแล้ว (${Math.min(done,total)}/${total})`;
      document.getElementById("scanStatus").textContent = `สแกนแล้ว (${Math.min(done,total)}/${total}) – กลุ่ม: ${group}`;
      // อัปเดตตารางกลางทาง (จะเห็นผลเร็วขึ้น และจะเรียง BUY ไว้บนสุด)
      if (js.savedPreview) renderTable(js.savedPreview);

      if (cursor == null) break;
      round++;
      // ป้องกัน spam exchange: หน่วงเล็กน้อย
      await new Promise(s=>setTimeout(s, 600));
    }
    // ปิดงาน โหลดผลล่าสุดอีกครั้ง
    await loadSignals();
  }catch(err){
    document.getElementById("scanStatus").textContent = `สั่งสแกนล้มเหลว: ${err}`;
  }finally{
    busy = false;
  }
}

// helper เรนเดอร์ตารางจาก payload savedPreview
function renderTable(payload){
  const group = payload.group || "-";
  const t = payload.updatedAt ? new Date(payload.updatedAt).toISOString() : "-";
  document.getElementById("latestGroup").textContent = group;
  document.getElementById("latestTime").textContent = t;

  let rows = Array.isArray(payload.results) ? payload.results.slice() : [];
  const rank = (d,w) => {
    if (String(d).toUpperCase()==="BUY" || String(w).toUpperCase()==="BUY") return 0;
    if (String(d).toUpperCase()==="SELL"|| String(w).toUpperCase()==="SELL") return 1;
    return 2;
  };
  rows.sort((a,b)=> rank(a.signalD,a.signalW) - rank(b.signalD,b.signalW));

  const tb = document.getElementById("rows");
  tb.innerHTML = "";
  if (!rows.length){
    tb.innerHTML = `<tr><td colspan="5" class="meta">ไม่พบสัญญาณในรอบการสแกนล่าสุด</td></tr>`;
    return;
  }
  for (const it of rows){
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${it.ticker||"-"}</td>
        <td>${
          it.signalD?.toUpperCase()==="BUY"  ? `<span class="badge buy">BUY</span>` :
          it.signalD?.toUpperCase()==="SELL" ? `<span class="badge sell">Sell</span>` :
          `<span class="badge">-</span>`
        }</td>
        <td>${
          it.signalW?.toUpperCase()==="BUY"  ? `<span class="badge warn">BUY</span>` :
          it.signalW?.toUpperCase()==="SELL" ? `<span class="badge sell">Sell</span>` :
          `<span class="badge">-</span>`
        }</td>
        <td>${it.price ?? "-"}</td>
        <td>${it.timeframe || "1D"}</td>
      </tr>
    `);
  }
}

// เริ่มต้น
(async function init(){
  loadSignals();
})();
</script>
</body>
</html>
