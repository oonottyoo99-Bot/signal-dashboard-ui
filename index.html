<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Signal Scanner Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0f172a;color:#e2e8f0}
    .wrap{max-width:1180px;margin:40px auto;padding:0 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{background:#0b1220;border:1px solid #1f2937;border-radius:20px;padding:6px 12px;cursor:pointer}
    .chip.active{background:#0e7490;border-color:#22d3ee}
    .chip .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#10b981;margin-right:6px}
    .panel{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:14px}
    .btn{background:#1e3a8a;border:none;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #1f2937;padding:10px 8px;text-align:left}
    th{color:#93c5fd}
    .pill{border-radius:999px;padding:2px 10px;display:inline-block;font-size:12px}
    .sell{background:#3f1e25;color:#fda4af;border:1px solid #7f1d1d}
    .buy{background:#064e3b;color:#86efac;border:1px solid #065f46}
    .muted{opacity:.65}
    .badge{font-size:12px;color:#93c5fd}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,input{background:#0f172a;color:#e2e8f0;border:1px solid #334155;border-radius:8px;padding:6px 8px}
  </style>
</head>
<body>
<div class="wrap">
  <h1 style="margin:0 0 16px">Signal Scanner Dashboard</h1>

  <!-- กลุ่ม Auto chips -->
  <div class="panel" style="margin-bottom:12px">
    <div class="row" id="autoChips"></div>
    <div class="badge" id="heartbeat" style="margin-top:8px">สถานะอัปเดต: -</div>
    <div style="margin-top:10px"><button class="btn" id="btnSave">บันทึกการตั้งค่า*</button>
      <span class="badge">* Auto-scan จะใส่คิวเป็น batch อัตโนมัติ</span></div>
  </div>

  <!-- Manual chips -->
  <div class="panel" style="margin-bottom:14px">
    <div class="row" id="manualChips"></div>
    <div class="row" style="justify-content:space-between;margin-top:10px">
      <div class="badge" id="scanNote">ยังไม่เริ่มสแกน</div>
      <div class="badge" id="scanStatus"><span class="dot" style="background:#facc15"></span> กำลังสแกน…</div>
    </div>
  </div>

  <!-- ตาราง -->
  <div class="panel">
    <div class="toolbar" style="justify-content:space-between">
      <div class="row">
        <div class="badge">กลุ่มล่าสุด: <span id="labelGroup">-</span></div>
        <div class="badge">อัปเดตเมื่อ: <span id="labelTime">-</span></div>
      </div>
      <div class="row">
        <label class="badge">แสดง/หน้า:
          <select id="pageSize">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="all">ทั้งหมด</option>
          </select>
        </label>
        <button class="btn" id="btnPrev">ก่อนหน้า</button>
        <div class="badge">หน้า <span id="pageNow">1</span>/<span id="pageTotal">1</span></div>
        <button class="btn" id="btnNext">ถัดไป</button>
        <button class="btn" id="btnRefresh">รีเฟรช</button>
      </div>
    </div>

    <table>
      <thead>
      <tr>
        <th>Ticker</th>
        <th>Signal (1D)</th>
        <th>Signal (1W)</th>
        <th>Price</th>
        <th>Timeframe</th>
      </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
const GROUPS = [
  {key:"sp500", label:"S&P 500"},
  {key:"nasdaq100", label:"Nasdaq 100"},
  {key:"altcoins", label:"Altcoins (OKX)"},
  {key:"binance_top200", label:"Binance Top 200"},
  {key:"okx_top200", label:"OKX Top 200"},
  {key:"bitkub", label:"Bitkub"},
  {key:"set50", label:"SET50"},
  {key:"set100", label:"SET100"},
  {key:"etfs", label:"ETFs"},
  {key:"gold", label:"ทองคำ"},
];

let lastGroup = null;
let results = [];        // ทั้งหมดของกลุ่ม
let page = 1;
let pageSize = 50;

const els = {
  autoChips: document.getElementById('autoChips'),
  manualChips: document.getElementById('manualChips'),
  heartbeat: document.getElementById('heartbeat'),
  scanNote: document.getElementById('scanNote'),
  scanStatus: document.getElementById('scanStatus'),
  labelGroup: document.getElementById('labelGroup'),
  labelTime: document.getElementById('labelTime'),
  pageSize: document.getElementById('pageSize'),
  pageNow: document.getElementById('pageNow'),
  pageTotal: document.getElementById('pageTotal'),
  tbody: document.getElementById('tbody'),
  btnPrev: document.getElementById('btnPrev'),
  btnNext: document.getElementById('btnNext'),
  btnRefresh: document.getElementById('btnRefresh'),
};

function chip(label, key){
  const d = document.createElement('div');
  d.className = 'chip';
  d.textContent = label;
  d.onclick = ()=> manualScan(key);
  return d;
}

function renderChips(){
  els.manualChips.innerHTML = "";
  GROUPS.forEach(g => els.manualChips.appendChild(chip(g.label, g.key)));
  els.autoChips.innerHTML = "";
  GROUPS.forEach(g => {
    const c = document.createElement('div');
    c.className = 'chip';
    c.innerHTML = `<span class="dot"></span>${g.label}`;
    els.autoChips.appendChild(c);
  });
}
renderChips();

function setStatusNote(txt){ els.scanNote.textContent = txt; }
function setStatusActive(active){
  els.scanStatus.innerHTML = active
    ? `<span class="dot" style="background:#facc15"></span> กำลังสแกน…`
    : `<span class="dot" style="background:#10b981"></span> สแกนเสร็จแล้ว`;
}

async function manualScan(group){
  lastGroup = group;
  setStatusNote("เริ่มสแกน…");
  setStatusActive(true);
  results = [];
  page = 1;

  // วิ่ง batch ต่อเองจนจบ
  let nextCursor = 0, total = 0, done = 0;
  do {
    const url = `/api/run-scan?group=${encodeURIComponent(group)}&manual=1&cursor=${nextCursor}&batchSize=100`;
    const r = await fetch(url);
    if (!r.ok) { setStatusNote(`ผิดพลาด: ${await r.text()}`); setStatusActive(false); return; }
    const js = await r.json();
    total = js.total || 0;
    const merged = js.savedPreview || {};
    results = Array.isArray(merged.results) ? merged.results : [];
    nextCursor = js.nextCursor;

    setStatusNote(`สแกนแล้ว: ${results.length}/${total} – กลุ่ม: ${group}`);
    renderTable();   // อัปเดตตาราง “ระหว่างทาง” ด้วย
  } while (nextCursor !== null);

  setStatusActive(false);
}

function sortResults(arr){
  // BUY ก่อนเสมอ (ถ้า 1D หรือ 1W เป็น Buy) แล้วค่อย A→Z
  return [...arr].sort((a,b)=>{
    const aBuy = (a.signalD==="Buy" || a.signalW==="Buy") ? 1 : 0;
    const bBuy = (b.signalD==="Buy" || b.signalW==="Buy") ? 1 : 0;
    if (aBuy !== bBuy) return bBuy - aBuy;
    return String(a.ticker).localeCompare(String(b.ticker));
  });
}

function computePages(){
  const n = results.length || 0;
  if (els.pageSize.value === "all"){ pageSize = n || 1; }
  else pageSize = parseInt(els.pageSize.value, 10);
  const totalPages = Math.max(1, Math.ceil(n / pageSize));
  if (page > totalPages) page = totalPages;
  els.pageNow.textContent = page;
  els.pageTotal.textContent = totalPages;
  return { n, totalPages };
}

function renderTable(){
  els.labelGroup.textContent = lastGroup ? lastGroup.toUpperCase() : "-";
  els.labelTime.textContent = new Date().toISOString().replace("T"," ").replace("Z","Z");

  const sorted = sortResults(results);
  const { n, totalPages } = computePages();
  const start = (page-1)*pageSize;
  const end = Math.min(start + pageSize, n);
  const view = sorted.slice(start, end);

  els.tbody.innerHTML = view.map(r=>{
    const s1 = r.signalD==="Buy" ? "buy pill" : (r.signalD==="Sell" ? "sell pill" : "pill muted");
    const s2 = r.signalW==="Buy" ? "buy pill" : (r.signalW==="Sell" ? "sell pill" : "pill muted");
    return `<tr>
      <td>${r.ticker}</td>
      <td><span class="${s1}">${r.signalD||"-"}</span></td>
      <td><span class="${s2}">${r.signalW||"-"}</span></td>
      <td>${r.price==null?'-':r.price}</td>
      <td><span class="pill muted">1D</span></td>
    </tr>`;
  }).join("");

  els.btnPrev.disabled = (page<=1);
  els.btnNext.disabled = (page>=totalPages);
}

// control
els.pageSize.onchange = ()=>{ page=1; renderTable(); };
els.btnPrev.onclick = ()=>{ if (page>1){ page--; renderTable(); } };
els.btnNext.onclick = ()=>{ page++; renderTable(); };
els.btnRefresh.onclick = ()=> renderTable();

// heartbeat ui
setInterval(()=>{
  els.heartbeat.textContent = "สถานะอัปเดต: " + new Date().toISOString();
}, 1000);

// เริ่มต้นให้กดสแกนกลุ่มไหนก่อนก็ได้
setStatusActive(false);
</script>
</body>
</html>
