<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signal Scanner Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    :root {
      --bg:#0b0d10; --panel:#12161b; --panel2:#0f1318; --text:#e7eef5;
      --ok:#20c997; --warn:#ffc107; --danger:#ff4d4f; --muted:#99a3ad; --chip:#0b2731;
      --chip-on:#0e6e84;
    }
    *{box-sizing:border-box}
    body{font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      margin:0;background:#0b0d10;color:var(--text)}
    .wrap{max-width:1080px;margin:40px auto;padding:0 16px}
    h1{font-weight:700;letter-spacing:.2px;margin:0 0 24px}
    .card{background:#12161b;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:16px 16px 8px;margin:16px 0}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .chip{background:#0b2731;border:1px solid rgba(255,255,255,.08);color:#e7eef5;padding:8px 12px;border-radius:999px;cursor:pointer;user-select:none}
    .chip.on{background:#0e6e84}
    .btn{background:#20c997;border:none;color:#001114;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.muted{background:#2a3139;color:#cbd5e1}
    .btn.warn{background:#ffc107;color:#3b2f00}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{border-bottom:1px solid rgba(255,255,255,.06);padding:10px 8px;text-align:left}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0b2731;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:3px 8px}
    .pill.sell{background:#30151a;border-color:#5d1f2a;color:#ffd5db}
    .muted{color:#99a3ad}
    .right{margin-left:auto}
    .small{font-size:12px}
    .progress{font-size:12px;color:#cbd5e1}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Signal Scanner Dashboard</h1>

    <!-- Auto-scan settings -->
    <div class="card">
      <div class="row" id="auto-row"></div>
      <div class="toolbar">
        <button class="btn" id="btn-save">บันทึกการตั้งค่า</button>
        <div class="progress" id="auto-msg"></div>
      </div>
    </div>

    <!-- Manual scan -->
    <div class="card">
      <div class="row" id="manual-row"></div>
      <div class="toolbar">
        <button class="btn warn" id="btn-refresh">รีเฟรช</button>
        <div class="progress" id="scan-msg"></div>
        <div class="right muted small">* ระบบจะสแกนเป็นก้อนอัตโนมัติ (batch) จนครบ</div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="row" style="align-items:center">
        <div>กลุ่มล่าสุด: <b id="cur-group">-</b></div>
        <div class="muted small">• อัปเดตเมื่อ: <span id="cur-time">-</span></div>
        <button class="btn muted right" id="btn-soft-refresh">รีเฟรช</button>
      </div>
      <table>
        <thead>
          <tr><th>Ticker</th><th>Signal</th><th>Price</th><th>Timeframe</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
const API_BASE = location.origin; // ใช้โดเมนเดียวกัน

// กลุ่มทั้งหมดต้องตรงกับ keys ใน data/symbols.json
const GROUPS = [
  ["sp500", "S&P 500"],
  ["nasdaq100", "Nasdaq 100"],
  ["altcoins", "Altcoins (OKX)"],
  ["binance_top200", "Binance Top 200"],
  ["okx_top200", "OKX Top 200"],
  ["bitkub", "Bitkub"],
  ["set50", "SET50"],
  ["set100", "SET100"],
  ["etf", "ETFs"],
  ["gold", "ทองคำ"],
];

// ---------- UI chips ----------
function renderGroupChips(container, onClick) {
  container.innerHTML = "";
  GROUPS.forEach(([key, label]) => {
    const el = document.createElement("div");
    el.className = "chip";
    el.textContent = label;
    el.dataset.key = key;
    el.addEventListener("click", () => onClick(key, el));
    container.appendChild(el);
  });
}

// ---------- Settings ----------
async function loadSettings() {
  const r = await fetch(`${API_BASE}/api/settings`);
  const js = await r.json();
  return js && js.auto_scan_groups ? js.auto_scan_groups : [];
}
async function saveSettings(groups) {
  const r = await fetch(`${API_BASE}/api/settings`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ auto_scan_groups: groups }),
  });
  if (!r.ok) throw new Error(`save settings HTTP ${r.status}`);
  return r.json();
}

// ---------- Signals ----------
async function loadSignals() {
  const r = await fetch(`${API_BASE}/api/signals`);
  if (!r.ok) throw new Error(`signals HTTP ${r.status}`);
  return r.json();
}
function drawTable(data) {
  document.getElementById("cur-group").textContent = data.group || "-";
  document.getElementById("cur-time").textContent = data.updatedAt || "-";
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";
  (data.results || []).forEach((row) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.ticker}</td>
      <td><span class="pill sell">${row.signal}</span></td>
      <td>${row.price == null ? "-" : row.price}</td>
      <td>${row.timeframe || "-"}</td>
    `;
    tb.appendChild(tr);
  });
}

// ---------- Batch manual scan ----------
async function runScanBatch(group, opts = { limit: 25 }) {
  let offset = 0;
  const limit = opts.limit || 25;
  const msg = document.getElementById("scan-msg");

  msg.textContent = "เริ่มสแกน...";
  for (;;) {
    const url = `${API_BASE}/api/run-scan?group=${encodeURIComponent(group)}&manual=1&limit=${limit}&offset=${offset}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error(`run-scan HTTP ${r.status}`);
    const js = await r.json();

    const total = js.total || 0;
    const scanned = Math.min(offset + (js.batch || 0), total);
    msg.textContent = `กำลังสแกนกลุ่ม ${group}... ${scanned}/${total}`;

    // อัปเดตตารางให้เห็นผลระหว่างทาง
    try {
      const latest = await loadSignals();
      drawTable(latest);
    } catch {}

    if (js.nextOffset == null) {
      msg.textContent = `สแกนเสร็จแล้ว (${total}/${total})`;
      break;
    }
    offset = js.nextOffset;
    // ป้องกันโดน rate-limit
    await new Promise((resolve) => setTimeout(resolve, 250));
  }
}

// ---------- Bootstrap ----------
(async () => {
  // Auto chips
  const autoRow = document.getElementById("auto-row");
  const autoMsg = document.getElementById("auto-msg");
  const selected = new Set(await loadSettings());
  renderGroupChips(autoRow, (key, el) => {
    if (selected.has(key)) { selected.delete(key); el.classList.remove("on"); }
    else { selected.add(key); el.classList.add("on"); }
  });
  // mark selected
  [...autoRow.children].forEach((el) => { if (selected.has(el.dataset.key)) el.classList.add("on"); });

  document.getElementById("btn-save").addEventListener("click", async () => {
    try {
      autoMsg.textContent = "กำลังบันทึก...";
      await saveSettings([...selected]);
      autoMsg.textContent = "บันทึกแล้ว";
      setTimeout(() => (autoMsg.textContent = ""), 1500);
    } catch (e) {
      autoMsg.textContent = "บันทึกล้มเหลว";
    }
  });

  // Manual chips
  const manualRow = document.getElementById("manual-row");
  renderGroupChips(manualRow, async (key, el) => {
    // วิ่ง batch อัตโนมัติ
    try {
      el.classList.add("on");
      await runScanBatch(key, { limit: 25 }); // ปรับได้ตามใจ 10-50
    } catch (e) {
      document.getElementById("scan-msg").textContent = String(e.message || e);
    } finally {
      el.classList.remove("on");
    }
  });

  // ปุ่มรีเฟรช
  document.getElementById("btn-refresh").addEventListener("click", async () => {
    try {
      document.getElementById("scan-msg").textContent = "รีเฟรช...";
      const latest = await loadSignals();
      drawTable(latest);
      document.getElementById("scan-msg").textContent = "";
    } catch (e) {
      document.getElementById("scan-msg").textContent = "โหลดไม่สำเร็จ";
    }
  });
  document.getElementById("btn-soft-refresh").addEventListener("click", async () => {
    try {
      const latest = await loadSignals();
      drawTable(latest);
    } catch {}
  });

  // โหลดตารางครั้งแรก
  try {
    const latest = await loadSignals();
    drawTable(latest);
  } catch {}
})();
</script>
</body>
</html>
