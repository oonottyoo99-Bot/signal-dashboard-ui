<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Signal Scanner Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<style>
  :root{
    --bg:#0f172a;--panel:#111827;--chip:#0b1220;--text:#dbeafe;--muted:#94a3b8;
    --buy:#16a34a;--sell:#ef4444;--dot:#22c55e;--warn:#eab308;
  }
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  body{margin:0;background:var(--bg);color:var(--text)}
  .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 16px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .chip{background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;border-radius:999px;padding:10px 14px;cursor:pointer}
  .chip.active{box-shadow:0 0 0 1px #2563eb inset}
  .status{font-size:12px;color:var(--muted)}
  .panel{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:12px;margin-top:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid #1f2937;text-align:left}
  th{color:#c7d2fe;font-weight:600}
  .badge{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid #1f2937;font-size:12px}
  .b-buy{color:#10b981;border-color:#10b98133;background:#065f4633}
  .b-sell{color:#f87171;border-color:#f8717133;background:#7f1d1d33}
  .b-dash{color:#9ca3af;border-color:#9ca3af33;background:#37415166}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,button{background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;border-radius:8px;padding:8px 12px}
  button.primary{background:#1d4ed8}
  .dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px;background:var(--dot)}
  .warn{color:#facc15}
  .right{margin-left:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>Signal Scanner Dashboard</h1>

  <!-- Auto summary line -->
  <div class="panel">
    <div class="row" id="autoSummary"></div>
    <div class="status right" id="heartbeat"></div>
  </div>

  <!-- Manual scan bar -->
  <div class="panel">
    <div class="row" id="groupsBar"></div>
    <div class="status" id="progressText">ยังไม่เริ่มสแกน</div>
    <div class="status right" id="scanState"><span class="dot"></span> สแกนเสร็จแล้ว</div>
  </div>

  <!-- Table -->
  <div class="panel">
    <div class="toolbar">
      <div id="groupNow">กลุ่มล่าสุด: -</div>
      <div id="updatedAt" class="status">อัปเดตเมื่อ: -</div>
      <div class="right"></div>
      <label>แสดง/หน้า:
        <select id="pageSize">
          <option>50</option><option>100</option><option selected>200</option><option>500</option>
        </select>
      </label>
      <button id="prevBtn">ก่อนหน้า</button>
      <div class="status" id="pageInfo">หน้า 1/1</div>
      <button id="nextBtn">ถัดไป</button>
      <button id="refreshBtn" class="primary">รีเฟรช</button>
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th style="min-width:140px">Ticker</th>
            <th>Signal (1D)</th>
            <th>Signal (1W)</th>
            <th>Price</th>
            <th>Timeframe</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="status" id="note">* ตารางจะคงผลลัพธ์ไว้จนกว่าจะสแกนกลุ่มใหม่</div>
  </div>
</div>

<script>
const G = [
  ["sp500","S&P 500"],["nasdaq100","Nasdaq 100"],["altcoins","Altcoins (OKX)"],
  ["binance_top200","Binance Top 200"],["okx_top200","OKX Top 200"],["bitkub","Bitkub"],
  ["set50","SET50"],["set100","SET100"],["etfs","ETFs"],["gold","ทองคำ"]
];

let state = {
  group:"", total:0, done:0, cursor:0, page:1, pageSize:200,
  results:[], // ทั้งหมด (ใช้แบ่งหน้า)
};

const el = sel => document.querySelector(sel);
const rows = el("#rows");
const progressText = el("#progressText");
const scanState = el("#scanState");
const groupNow = el("#groupNow");
const updatedAt = el("#updatedAt");
const pageInfo = el("#pageInfo");

function badge(text){
  if (text==="Buy") return `<span class="badge b-buy">Buy</span>`;
  if (text==="Sell")return `<span class="badge b-sell">Sell</span>`;
  return `<span class="badge b-dash">-</span>`;
}

function renderGroupsBar(){
  const bar = el("#groupsBar");
  bar.innerHTML = G.map(([k,lab]) => `<div class="chip" data-k="${k}">${lab}</div>`).join("");
  bar.addEventListener("click", async (e)=>{
    const k = e.target.closest(".chip")?.dataset.k;
    if(!k) return;
    bar.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
    e.target.closest(".chip").classList.add("active");
    await startManual(k);
  });
}
function renderAutoSummary(){
  el("#autoSummary").innerHTML = G.map(([k,lab]) =>
    `<div class="chip">${lab}</div>`).join("");
}

// เรียก API สแกนแบบ batch ต่อเนื่องจนจบ
async function startManual(group){
  state = { ...state, group, total:0, done:0, cursor:0, page:1, results:[] };
  renderProgress();

  let next = 0;
  let safe = 0;
  while (next !== null && safe < 2000){ // guard
    safe++;
    const url = `/api/run-scan?group=${group}&manual=1&cursor=${next}&batchSize=200`;
    const r = await fetch(url);
    const js = await r.json();
    if(!r.ok){ progressText.textContent = `ผิดพลาด: ${JSON.stringify(js)}`; break; }

    state.total = js.total;
    state.done  = Math.min((js.savedPreview?.results?.length||0), js.total);
    state.cursor = js.nextCursor ?? null;
    // ใช้ผลสะสมที่เพิ่งบันทึก เพื่อให้ตาราง “ครบทุกตัว”
    state.results = Array.isArray(js.savedPreview?.results)? js.savedPreview.results : [];
    next = js.nextCursor;

    // sort: มี Buy ใด ๆ ขึ้นก่อน
    state.results.sort((a,b)=>{
      const A = (a.signalD==="Buy"||a.signalW==="Buy")?1:0;
      const B = (b.signalD==="Buy"||b.signalW==="Buy")?1:0;
      return B - A;
    });

    groupNow.textContent = `กลุ่มล่าสุด: ${groupLabel(group)}`;
    updatedAt.textContent = `อัปเดตเมื่อ: ${js.savedPreview?.updatedAt || "-"}`;
    renderProgress();
    renderTable();
    // เว้นจังหวะนิดกัน rate limit
    await new Promise(rs=>setTimeout(rs, 400));
  }
}

function groupLabel(k){ return (G.find(x=>x[0]===k)||[])[1] || k; }

function renderProgress(){
  progressText.textContent = `สแกนแล้ว: ${state.done}/${state.total} – กลุ่ม: ${state.group||"-"}`;
  scanState.innerHTML = (state.cursor===null)
    ? `<span class="dot"></span> สแกนเสร็จแล้ว`
    : `<span class="dot" style="background:var(--warn)"></span> กำลังสแกน...`;
}

function renderTable(){
  const ps = state.pageSize, pg = state.page;
  const start = (pg-1)*ps, end = start+ps;
  const slice = state.results.slice(start, end);
  rows.innerHTML = slice.map(r => `
    <tr>
      <td>${r.ticker}</td>
      <td>${badge(r.signalD)}</td>
      <td>${badge(r.signalW)}</td>
      <td>${r.price ?? "-"}</td>
      <td>${r.timeframe || "-"}</td>
    </tr>
  `).join("") || `<tr><td colspan="5" class="status">ไม่พบสัญญาณในการสแกนล่าสุด</td></tr>`;

  const pages = Math.max(1, Math.ceil(state.results.length / ps));
  pageInfo.textContent = `หน้า ${pg}/${pages}`;
}

el("#pageSize").addEventListener("change", e=>{
  state.pageSize = parseInt(e.target.value,10) || 200;
  state.page = 1;
  renderTable();
});
el("#prevBtn").addEventListener("click", ()=>{
  if(state.page>1){ state.page--; renderTable(); }
});
el("#nextBtn").addEventListener("click", ()=>{
  const pages = Math.max(1, Math.ceil(state.results.length / state.pageSize));
  if(state.page<pages){ state.page++; renderTable(); }
});
el("#refreshBtn").addEventListener("click", renderTable);

// heartbeat (เวลาเซิร์ฟเวอร์)
setInterval(()=>{ el("#heartbeat").textContent = `สถานะอัปเดต: ${new Date().toISOString()}`; }, 1000);

// init
renderGroupsBar();
renderAutoSummary();
renderTable();
</script>
</body>
</html>
