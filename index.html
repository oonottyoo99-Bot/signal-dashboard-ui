<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signal Scanner Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    :root{
      --bg:#0b0d10; --panel:#12161b; --text:#e7eef5;
      --muted:#99a3ad; --primary:#16c2f5; --ok:#1fd36b; --warn:#ffc107; --danger:#ff4d4f;
      --chip:#0b2731; --chip-on:#0e6e84; --chip-off:#2b333c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0b0d10;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    h1{font-weight:700;letter-spacing:.2px;margin:4px 0 20px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:18px;margin:12px 0}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .chip{padding:8px 12px;border-radius:999px;background:#0f2028;color:#cfe8f3;border:1px solid rgba(255,255,255,.08);cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .chip .dot{width:8px;height:8px;border-radius:50%}
    .chip .dot.open{background:var(--ok)}
    .chip .dot.close{background:#777}
    .chip.active{outline:2px solid var(--primary)}
    .btn{background:#0f2028;color:#fff;border:1px solid rgba(255,255,255,.1);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#0e6e84}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{color:#b8c3cc;font-weight:600}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15)}
    .b-sell{background:#2b1517;color:#ff9aa1}
    .b-buy{background:#142a1b;color:#6af0a3}
    .b-muted{background:#1b2026;color:#9fb2be}
    .muted{color:#9fb2be}
    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .note{font-size:12px;color:#9fb2be}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Signal Scanner Dashboard</h1>

    <!-- แถว Auto-scan (ปุ่ม + สถานะตลาด) -->
    <div class="card">
      <div class="row" id="autoRow"></div>
      <div class="flex" style="margin-top:10px">
        <button class="btn primary" id="saveBtn">บันทึกการตั้งค่า</button>
        <span class="note">* Auto-scan จะใส่คิวเป็น batch อัตโนมัติ</span>
        <span class="right note" id="statusTs"></span>
      </div>
    </div>

    <!-- แถว Manual scan (ปุ่ม + counter) -->
    <div class="card">
      <div class="row" id="manualRow"></div>
      <div style="margin-top:10px">
        <button class="btn" id="refreshBtn">รีเฟรช</button>
        <span class="note" id="lastMsg"></span>
      </div>
    </div>

    <!-- ตารางผลลัพธ์ -->
    <div class="card">
      <div class="flex">
        <div>กลุ่มล่าสุด: <b id="grp">-</b></div>
        <div class="muted">• อัปเดตเมื่อ: <span id="upd">-</span></div>
        <button class="btn right" id="reloadTable">รีเฟรช</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Signal (1D)</th>
            <th>Signal (1W)</th>
            <th>Price</th>
            <th>Timeframe</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5" class="muted">ไม่พบสัญญาณในรอบการสแกนล่าสุด</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
const API = (p)=> (window.NEXT_PUBLIC_API_BASE || '') + p;
const GROUPS = [
  ["sp500","S&P 500"],
  ["nasdaq100","Nasdaq 100"],
  ["altcoins","Altcoins (OKX)"],
  ["binance_top200","Binance Top 200"],
  ["okx_top200","OKX Top 200"],
  ["bitkub","Bitkub"],
  ["set50","SET50"],
  ["set100","SET100"],
  ["etfs","ETFs"],
  ["gold","ทองคำ"],
];

let counters = {};     // { group: {done,total} }
let marketStat = {};  // { group: {open,source,note} }

async function init(){
  renderButtons();
  await loadMarketStatus();
  await loadSavedCounters();
  await loadSignalsTable();
}
function renderButtons(){
  const auto = document.getElementById('autoRow');
  const man  = document.getElementById('manualRow');
  auto.innerHTML = ""; man.innerHTML = "";

  for (const [key,label] of GROUPS){
    const c1 = document.createElement('div');
    c1.className = 'chip';
    c1.dataset.group = key;
    c1.innerHTML = `<span class="dot close"></span>${label}`;
    c1.onclick = ()=>toggleAuto(key);
    auto.appendChild(c1);

    const c2 = document.createElement('div');
    c2.className = 'chip';
    c2.dataset.group = key;
    c2.onclick = ()=>manualScan(key);
    c2.innerHTML = `<span class="dot close"></span>${label} <span class="muted" id="cnt-${key}"></span>`;
    man.appendChild(c2);
  }
}
async function loadMarketStatus(){
  try{
    const r = await fetch(API('/api/market-status'));
    const js = await r.json();
    marketStat = js.status || {};
    document.getElementById('statusTs').textContent = 'สถานะอัปเดต: ' + (js.ts||'');
  }catch(e){ console.warn('market-status', e); }

  for (const [key] of GROUPS){
    const st = marketStat[key];
    const dots = document.querySelectorAll(`.chip[data-group="${key}"] .dot`);
    dots.forEach(d => d.className = `dot ${st && st.open ? 'open' : 'close'}`);
  }
}
async function loadSavedCounters(){
  // ใช้ /api/signals เพื่อเช็คกลุ่มล่าสุด
  try{
    const r = await fetch(API('/api/signals'));
    const js = await r.json();
    if (js.group && Array.isArray(js.results)){
      counters[js.group] = { done: js.results.length, total: js.results.length };
      updateCounter(js.group);
    }
  }catch(e){}
}
function updateCounter(g){
  const t = document.getElementById('cnt-'+g);
  const c = counters[g];
  if (t && c) t.textContent = `สแกนเสร็จแล้ว (${c.done}/${c.total})`;
}

// บันทึกการตั้งค่า auto-scan (เรียก /api/settings POST)
document.getElementById('saveBtn').onclick = async ()=>{
  const groups = GROUPS.map(([g])=>g); // demo: เลือกทั้งหมด
  try{
    await fetch(API('/api/settings'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ auto_scan_groups: groups })});
    alert('บันทึกแล้ว');
  }catch(e){ alert('บันทึกล้มเหลว'); }
};

async function manualScan(group){
  try{
    // ดึงจำนวนทั้งหมดก่อน (ขอ batch size=1 เพื่อได้ total)
    const head = await fetch(API(`/api/run-scan?group=${group}&manual=1&batchSize=1&cursor=0`));
    const hjs = await head.json();
    if (!hjs.ok) throw new Error(hjs.error||'scan head failed');

    counters[group] = { done: 0, total: hjs.total };
    updateCounter(group);

    // ไล่ยิง batch จนครบ
    let cursor = 1;
    const batch = 50; // ขนาดชุด
    while (cursor !== null){
      const r = await fetch(API(`/api/run-scan?group=${group}&manual=1&batchSize=${batch}&cursor=${cursor}`));
      const js = await r.json();
      if (!js.ok) throw new Error(js.error||'scan batch failed');
      counters[group].done = Math.min(js.end+1, js.total);
      updateCounter(group);
      cursor = js.nextCursor;
    }
    document.getElementById('lastMsg').textContent = `สแกนเสร็จแล้ว • กลุ่ม: ${group}`;
    await loadSignalsTable();
  }catch(e){
    console.error(e);
    document.getElementById('lastMsg').textContent = `สั่งสแกนล้มเหลว: ${e.message||e}`;
  }
}

document.getElementById('refreshBtn').onclick = ()=>loadSignalsTable();
document.getElementById('reloadTable').onclick = ()=>loadSignalsTable();

async function loadSignalsTable(){
  try{
    const r = await fetch(API('/api/signals'));
    const js = await r.json();
    document.getElementById('grp').textContent = js.group || '-';
    document.getElementById('upd').textContent = js.updatedAt || '-';
    const tb = document.getElementById('rows');
    tb.innerHTML = "";
    const list = Array.isArray(js.results) ? js.results : [];
    if (!list.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">ไม่พบสัญญาณในรอบการสแกนล่าสุด</td></tr>`;
      return;
    }
    for (const it of list){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(it.ticker)}</td>
        <td>${badge(it.signalD)}</td>
        <td>${badge(it.signalW)}</td>
        <td>${it.price ?? '-'}</td>
        <td>${it.timeframe || '1D'}</td>
      `;
      tb.appendChild(tr);
    }
  }catch(e){
    const tb = document.getElementById('rows');
    tb.innerHTML = `<tr><td colspan="5" class="muted">โหลดข้อมูลล้มเหลว</td></tr>`;
  }
}
function badge(sig){
  if (sig === 'Buy') return `<span class="badge b-buy">Buy</span>`;
  if (sig === 'Sell') return `<span class="badge b-sell">Sell</span>`;
  return `<span class="badge b-muted">-</span>`;
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

window.addEventListener('load', init);
</script>
</body>
</html>
