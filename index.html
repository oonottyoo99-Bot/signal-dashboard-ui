<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Signal Scanner Dashboard</title>
  <style>
    :root{
      --bg:#0f1720;--panel:#131c26;--chip:#0f2436;--line:#203042;
      --text:#e6eef7;--muted:#9fb5c9;--ok:#2bd576;--warn:#f6b83f;--bad:#ff6b6b;--btn:#245c9c;
      --pill:#162a3c;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1160px;margin:24px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px 16px;margin:12px 0}
    .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:8px 14px;cursor:pointer;user-select:none}
    .chip.active{outline:2px solid var(--ok)}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px;background:var(--ok)}
    .btn{background:var(--btn);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{color:#cfe3fa;font-weight:600;background:var(--pill)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#102231}
    .pill.buy{background:#0f2d1c;border-color:#1a4c2d;color:#8df3b1}
    .pill.sell{background:#2a1010;border-color:#5b2525;color:#ff9e9e}
    .right{margin-left:auto}
    .status{padding:6px 10px;border-radius:8px;background:#102331;border:1px solid var(--line);color:var(--muted)}
    .msg{margin-top:8px;color:#ffd9a8}
    .controls{display:flex;gap:8px;align-items:center}
    select{background:#0d2032;color:#d9ebff;border:1px solid var(--line);border-radius:6px;padding:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Signal Scanner Dashboard</h1>

    <!-- กลุ่ม Auto สถานะ -->
    <div class="panel">
      <div class="row" id="autoGroups">
        <!-- chips ด้านบน -->
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnSave">บันทึกการตั้งค่า*</button>
        <span class="hint">* Auto-scan จะไล่สแกนเป็น batch อัตโนมัติ</span>
        <span class="status right" id="heartbeat">สถานะอัปเดต: -</span>
      </div>
    </div>

    <!-- แถวสแกนด้วยตนเอง -->
    <div class="panel">
      <div class="row" id="manualGroups"></div>
      <div class="row" style="margin-top:8px">
        <span id="progress" class="status">ยังไม่เริ่มสแกน</span>
        <span id="badgeBusy" class="status right" style="display:none"><span class="dot" style="background:var(--warn)"></span>กำลังสแกน…</span>
        <span id="badgeDone" class="status right" style="display:none"><span class="dot"></span>สแกนเสร็จแล้ว</span>
      </div>
      <div class="msg" id="toast"></div>
    </div>

    <!-- ตาราง -->
    <div class="panel">
      <div class="row">
        <div class="status">กลุ่มล่าสุด: <b id="labelGroup">-</b> • อัปเดตเมื่อ: <b id="labelTime">-</b></div>
        <div class="right controls">
          <label>แสดง/หน้า:
            <select id="perPage">
              <option>50</option>
              <option>100</option>
              <option>200</option>
              <option>500</option>
            </select>
          </label>
          <button class="btn" id="btnPrev">ก่อนหน้า</button>
          <span class="status" id="labelPage">หน้า 1/1</span>
          <button class="btn" id="btnNext">ถัดไป</button>
          <button class="btn" id="btnRefresh">รีเฟรช</button>
        </div>
      </div>

      <table id="grid">
        <thead>
          <tr>
            <th style="width:28%">Ticker</th>
            <th style="width:16%">Signal (1D)</th>
            <th style="width:16%">Signal (1W)</th>
            <th style="width:16%">Price</th>
            <th style="width:12%">Timeframe</th>
          </tr>
        </thead>
        <tbody id="gridBody">
          <tr><td colspan="5" class="hint">ไม่พบสัญญาณในการสแกนล่าสุด</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
const groups = [
  {key:"sp500",        label:"S&P 500"},
  {key:"nasdaq100",    label:"Nasdaq 100"},
  {key:"altcoins",     label:"Altcoins (OKX)"},
  {key:"binance_top200", label:"Binance Top 200"},
  {key:"okx_top200",   label:"OKX Top 200"},
  {key:"bitkub",       label:"Bitkub"},
  {key:"set50",        label:"SET50"},
  {key:"set100",       label:"SET100"},
  {key:"etfs",         label:"ETFs"},
  {key:"gold",         label:"ทองคำ"},
];

let state = {
  currentGroup: null,
  table: { page:1, perPage:50, data:[], updatedAt:"-" },
  progress: { text:"ยังไม่เริ่มสแกน" },
  busy: false,
  nextCursor: null,
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

function chip(label, key){
  const el = document.createElement("div");
  el.className = "chip";
  el.textContent = label;
  el.onclick = () => startManual(key);
  return el;
}

// render chips
function renderChips(){
  const a = $("#autoGroups");
  const m = $("#manualGroups");
  a.innerHTML = "";
  m.innerHTML = "";
  groups.forEach(g=>{
    const c1 = chip(g.label, g.key);
    const c2 = chip(g.label, g.key);
    a.appendChild(c1);
    m.appendChild(c2);
  });
}
renderChips();

$("#btnSave").onclick = () => showToast("บันทึกเรียบร้อย (ตัวอย่าง)");

// manual scan
async function startManual(group){
  if(state.busy) return;
  state.busy = true;
  state.currentGroup = group;
  state.nextCursor = 0;
  $("#badgeBusy").style.display = "";
  $("#badgeDone").style.display = "none";
  $("#progress").textContent = "กำลังเริ่มสแกน…";
  await loopBatch();
  state.busy = false;
  $("#badgeBusy").style.display = "none";
  $("#badgeDone").style.display = "";
}

async function loopBatch(){
  const bs = 100; // สแกนทีละ 100 ตัว/คำขอ (เร็วขึ้น)
  while (state.nextCursor !== null){
    const url = `/api/run-scan?group=${state.currentGroup}&manual=1&cursor=${state.nextCursor}&batchSize=${bs}`;
    let js;
    try{
      const r = await fetch(url);
      js = await r.json();
      if(!r.ok || !js?.ok) throw new Error(JSON.stringify(js));
    }catch(e){
      showToast("ผิดพลาด: "+ (e.message||e), true);
      state.nextCursor = null;
      break;
    }
    state.nextCursor = js.nextCursor;
    $("#progress").textContent = `สแกนแล้ว: ${js.savedPreview.results.length}/${js.total} – กลุ่ม: ${js.group}`;
    // อัปเดตตาราง (ดึงผลสะสมล่าสุดจาก response)
    state.table.data = js.savedPreview.results.slice(0); // copy
    state.table.updatedAt = js.savedPreview.updatedAt;
    state.table.page = 1;
    renderTable();
    await sleep(200); // ผ่อน API
  }
}

function renderTable(){
  $("#labelGroup").textContent = state.currentGroup || "-";
  $("#labelTime").textContent = state.table.updatedAt || "-";

  // sort: ถ้าเจอ BUY ใน 1D/1W ให้ขึ้นก่อน
  const sorted = state.table.data.slice().sort((a,b)=>{
    const aBuy = (a.signalD==="Buy") || (a.signalW==="Buy");
    const bBuy = (b.signalD==="Buy") || (b.signalW==="Buy");
    if (aBuy && !bBuy) return -1;
    if (!aBuy && bBuy) return 1;
    return a.ticker.localeCompare(b.ticker);
  });

  const per = state.table.perPage;
  const total = sorted.length;
  const pages = Math.max(1, Math.ceil(total/per));
  state.table.page = Math.min(state.table.page, pages);
  $("#labelPage").textContent = `หน้า ${state.table.page}/${pages}`;

  const start = (state.table.page-1)*per;
  const end = Math.min(start+per, total);
  const slice = sorted.slice(start,end);

  const tbody = $("#gridBody");
  tbody.innerHTML = "";
  if (!slice.length){
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 5;
    td.className = "hint";
    td.textContent = "ไม่พบสัญญาณในการสแกนล่าสุด";
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  for (const r of slice){
    const tr = document.createElement("tr");

    const td1 = document.createElement("td"); td1.textContent = r.ticker;
    const td2 = document.createElement("td"); td2.innerHTML = pill(r.signalD);
    const td3 = document.createElement("td"); td3.innerHTML = pill(r.signalW);
    const td4 = document.createElement("td"); td4.textContent = r.price==null? "-" : r.price;
    const td5 = document.createElement("td"); td5.innerHTML = `<span class="pill">1D</span> <span class="pill">1W</span>`;

    tr.append(td1,td2,td3,td4,td5);
    tbody.appendChild(tr);
  }
}

function pill(sig){
  if (sig==="Buy") return `<span class="pill buy">Buy</span>`;
  if (sig==="Sell") return `<span class="pill sell">Sell</span>`;
  return `<span class="pill">-</span>`;
}

$("#perPage").onchange = (e)=>{ state.table.perPage = parseInt(e.target.value,10)||50; state.table.page=1; renderTable(); };
$("#btnPrev").onclick = ()=>{ if(state.table.page>1){ state.table.page--; renderTable(); } };
$("#btnNext").onclick = ()=>{ const total = state.table.data.length; const pages = Math.max(1, Math.ceil(total/state.table.perPage)); if(state.table.page<pages){ state.table.page++; renderTable(); } };
$("#btnRefresh").onclick = ()=> renderTable();

function showToast(msg, isErr){
  const el = $("#toast");
  el.textContent = msg;
  el.style.color = isErr? "#ff9e9e":"#ffd9a8";
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

// heartbeat (โชว์เวลาอัปเดต)
setInterval(()=>{
  $("#heartbeat").textContent = "สถานะอัปเดต: " + new Date().toISOString();
}, 1000);
</script>
</body>
</html>
