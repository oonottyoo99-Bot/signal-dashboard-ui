<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Signal Scanner Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b0d10;--panel:#12161b;--panel2:#0f1318;--text:#d7dee7;--muted:#8ca3b6;--ok:#1fa973;--warn:#ffc107;--danger:#ff4d4f}
  *{box-sizing:border-box} body{margin:0;background:#0b0d10;color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial}
  .wrap{max-width:1080px;margin:40px auto;padding:0 16px}
  h1{margin:6px 0 22px;text-align:center;font-weight:700}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01)),var(--panel);
        border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:14px}
  .row{display:flex;flex-wrap:wrap;gap:10px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:#0f1a22;border:1px solid rgba(255,255,255,.06);cursor:pointer}
  .dot{width:8px;height:8px;border-radius:50%;background:#3a4a57}
  .ok .dot{background:var(--ok)} .err .dot{background:var(--danger)}
  .btn{padding:10px 14px;border-radius:10px;background:#12415f;border:1px solid #1b5d87;color:#dff0ff;cursor:pointer}
  .btn.secondary{background:#2a3340;border-color:#3a4655} .btn:disabled{opacity:.6;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#0e1820;border:1px solid #1a2a36}
  .right{margin-left:auto}
  .muted{color:var(--muted);font-size:13px}
  .space{height:10px}
  table{width:100%;border-collapse:collapse} th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06)}
  th{background:#0f1318;color:#a7b5c4;text-align:left}
  tr:hover td{background:rgba(255,255,255,.02)}
  .badge{display:inline-flex;align-items:center;min-width:34px;height:24px;padding:0 10px;border-radius:999px;font-size:12px;border:1px solid transparent}
  .buy{background:#0d3926;color:#62ffb3;border-color:#1fa973}
  .sell{background:#351519;color:#ffb3b8;border-color:#ff4d4f}
  .flat{background:#1b2330;color:#9fb2c6;border-color:#2a394a}
  .status{display:flex;align-items:center;gap:8px}
  .status .dot{width:10px;height:10px}
  .k-red{color:#ffb3b8} .k-green{color:#82ffca}
</style>
</head>
<body>
<div class="wrap">
  <h1>Signal Scanner Dashboard</h1>

  <!-- แถบ auto -->
  <div class="card">
    <div class="row" id="marketRow"></div>
    <div class="space"></div>
    <div class="row">
      <button class="btn" id="btnSave">บันทึกการตั้งค่า</button>
      <div class="pill">* Auto-scan จะใส่คิวเป็น batch อัตโนมัติ</div>
      <div class="right status" id="statusClock"><span class="dot"></span><span>-</span></div>
    </div>
  </div>

  <div class="space"></div>

  <!-- manual -->
  <div class="card">
    <div class="row" id="manualRow"></div>
    <div class="space"></div>
    <div class="row">
      <button class="btn secondary" id="btnRefresh">รีเฟรช</button>
      <div class="pill" id="progressPill">สแกนแล้ว: -</div>
      <div class="right status" id="scanState"><span class="dot"></span><span>พัก</span></div>
    </div>
  </div>

  <div class="space"></div>

  <!-- table -->
  <div class="card">
    <div class="row">
      <div class="pill" id="groupPill">กลุ่มล่าสุด: -</div>
      <div class="pill" id="updatedPill">อัปเดตเมื่อ: -</div>
      <button class="btn secondary right" id="btnSoftRefresh">รีเฟรช</button>
    </div>
    <div class="space"></div>
    <table>
      <thead>
        <tr>
          <th style="width:32%">Ticker</th>
          <th style="width:16%">Signal (1D)</th>
          <th style="width:16%">Signal (1W)</th>
          <th style="width:16%">Price</th>
          <th style="width:20%">Timeframe</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="5" class="muted">ไม่พบสัญญาณในการสแกนล่าสุด</td></tr></tbody>
    </table>
    <div class="muted" style="margin-top:8px">* ตารางจะค้างผลลัพธ์ไว้จนกว่าจะมีผลใหม่ หรือคุณเลือกกลุ่มอื่น</div>
  </div>
</div>

<script>
/* ====== config / state ====== */
const GROUPS = [
  {key:"sp500",name:"S&P 500"},
  {key:"nasdaq100",name:"Nasdaq 100"},
  {key:"altcoins",name:"Altcoins (OKX)"},
  {key:"binance_top200",name:"Binance Top 200"},
  {key:"okx_top200",name:"OKX Top 200"},
  {key:"bitkub",name:"Bitkub"},
  {key:"set50",name:"SET50"},
  {key:"set100",name:"SET100"},
  {key:"etfs",name:"ETFs"},
  {key:"gold",name:"ทองคำ"},
];
let currentGroup = null;
const lastResultsByGroup = new Map(); // group -> {updatedAt,total,results[]}
let aborter = null;
let scanning = false;

/* ====== dom helpers ====== */
const $ = s => document.querySelector(s);
function chip(g, onClick){
  const el = document.createElement('div');
  el.className = 'chip ok';
  el.innerHTML = `<span class="dot"></span>${g.name}<span class="muted" id="count-${g.key}" style="margin-left:6px"> สแกนแล้ว (0/0)</span>`;
  el.addEventListener('click', onClick);
  return el;
}
function setClock(ok=true,msg){
  const el = $('#statusClock');
  el.querySelector('.dot').style.background = ok ? 'var(--ok)' : 'var(--danger)';
  el.querySelector('span:last-child').textContent = msg;
}
function setScanState(state, text){
  const el = $('#scanState');
  el.querySelector('.dot').style.background =
    state==='busy' ? '#e7b416' : (state==='err' ? 'var(--danger)' : 'var(--ok)');
  el.querySelector('span:last-child').textContent = text;
}
function fmt(ts){
  if(!ts) return '-';
  const d = new Date(ts);
  return isNaN(d) ? '-' : d.toLocaleString();
}
function badge(sig){
  const s = (sig||'-')+'';
  let cls='flat', txt=s;
  if (s==='Buy'){cls='buy';txt='Buy'}
  else if (s==='Sell'){cls='sell';txt='Sell'}
  return `<span class="badge ${cls}">${txt}</span>`;
}
function renderCounts(){
  for (const {key} of GROUPS){
    const rec = lastResultsByGroup.get(key);
    const el = document.getElementById(`count-${key}`);
    if (!el) continue;
    if (rec?.results?.length){
      el.textContent = ` สแกนแล้ว (${rec.results.length}/${rec.total||rec.results.length})`;
    } else {
      el.textContent = ` สแกนแล้ว (0/0)`;
    }
  }
}
function renderTable(group){
  const rec = lastResultsByGroup.get(group);
  $('#groupPill').textContent = 'กลุ่มล่าสุด: ' + (GROUPS.find(g=>g.key===group)?.name || '-');
  $('#updatedPill').textContent = 'อัปเดตเมื่อ: ' + fmt(rec?.updatedAt);

  const tb = $('#tbody');
  if(!rec?.results?.length){
    tb.innerHTML = `<tr><td colspan="5" class="muted">ไม่พบสัญญาณในการสแกนล่าสุด</td></tr>`;
    return;
  }
  const rows = [...rec.results];
  rows.sort((a,b)=>{
    const aBuy = (a.signalD==='Buy') || (a.signalW==='Buy');
    const bBuy = (b.signalD==='Buy') || (b.signalW==='Buy');
    if (aBuy!==bBuy) return aBuy? -1 : 1;
    return (a.ticker||'').localeCompare(b.ticker||'');
  });
  tb.innerHTML = rows.map(r=>{
    return `<tr>
      <td>${escape((r.ticker||'-'))}</td>
      <td>${badge(r.signalD)}</td>
      <td>${badge(r.signalW)}</td>
      <td>${r.price ?? '-'}</td>
      <td><span class="pill">${r.timeframe||'1D'}</span></td>
    </tr>`;
  }).join('');
}
const escape = s => String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

/* ====== API helpers (ถ้าพังจะโยน error พร้อมข้อความอ่านง่าย) ====== */
async function getJSON(url){
  let r;
  try{ r = await fetch(url); }
  catch(e){ throw new Error(`network error: ${e?.message||e}`); }
  if (!r.ok){
    let t = '';
    try{ t = await r.text(); } catch {}
    throw new Error(`HTTP ${r.status} ${t||r.statusText}`);
  }
  return r.json();
}

/* ====== load latest to state (ไม่บังคับให้ตารางหาย) ====== */
async function loadLatest(){
  try{
    const js = await getJSON('/api/signals');
    if (js?.group && Array.isArray(js.results)){
      lastResultsByGroup.set(js.group, {updatedAt:js.updatedAt, total:js.results.length, results:js.results});
      if (!currentGroup) currentGroup = js.group;
      renderCounts(); renderTable(currentGroup);
    }
    setClock(true, 'สถานะอัปเดต: ' + new Date().toISOString());
  }catch(e){
    setClock(false, 'โหลดผลล่าสุดไม่ได้');
  }
}

/* ====== manual batching ====== */
async function runScan(group){
  // ยกเลิกงานเดิมถ้ามี
  if (aborter){ aborter.abort(); }
  aborter = new AbortController();

  scanning = true;
  currentGroup = group;
  setScanState('busy','กำลังสแกน...');
  $('#progressPill').textContent = `สแกนแล้ว: - – กลุ่ม: ${group}`;
  renderTable(group); // ค้างผลเดิมไว้

  let cursor = 0;
  let total = 0;

  while (scanning){
    try{
      const url = `/api/run-scan?group=${encodeURIComponent(group)}&manual=1&batchSize=50&cursor=${cursor}`;
      const r = await fetch(url,{signal:aborter.signal});
      if (!r.ok){
        const t = await r.text().catch(()=>r.statusText);
        throw new Error(`HTTP ${r.status} ${t}`);
      }
      const js = await r.json();

      // update cache/table
      if (js.savedPreview?.results){
        lastResultsByGroup.set(group, {
          updatedAt: js.savedPreview.updatedAt,
          total: js.total || js.savedPreview.results.length,
          results: js.savedPreview.results
        });
        renderCounts();
        if (currentGroup===group) renderTable(group);
      }

      total = js.total || total;
      $('#progressPill').textContent = `สแกนแล้ว: ${(lastResultsByGroup.get(group)?.results?.length||0)}/${total||'?' } – กลุ่ม: ${group}`;

      if (js.nextCursor==null) break;
      cursor = js.nextCursor;
      await new Promise(r=>setTimeout(r,250));
    }catch(e){
      if (e.name === 'AbortError'){ return; }
      setScanState('err','ผิดพลาด');
      $('#progressPill').innerHTML = `สแกนแล้ว: - <span class="k-red">สั่งสแกนล้มเหลว: ${escape(e.message||'scan failed')}</span>`;
      scanning = false;
      return;
    }
  }
  scanning = false;
  setScanState('ok','สแกนเสร็จแล้ว');
}

function buildUI(){
  // auto chips (แค่แสดงไฟสถานะ/ตัวนับ)
  const marketRow = $('#marketRow'); marketRow.innerHTML='';
  for (const g of GROUPS){
    marketRow.appendChild(chip(g, ()=>{}));
  }
  // manual chips
  const manual = $('#manualRow'); manual.innerHTML='';
  for (const g of GROUPS){
    manual.appendChild(chip(g, ()=> runScan(g.key)));
  }
}

/* ====== buttons ====== */
$('#btnRefresh').addEventListener('click', ()=>{ if(currentGroup) runScan(currentGroup) });
$('#btnSoftRefresh').addEventListener('click', loadLatest);
$('#btnSave').addEventListener('click', async ()=>{
  try{
    await fetch('/api/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({auto_scan_groups:[]})});
    alert('บันทึกแล้ว');
  }catch{ alert('บันทึกไม่สำเร็จ'); }
});

/* ====== boot ====== */
buildUI();
loadLatest();
setInterval(()=> setClock(true,'สถานะอัปเดต: '+new Date().toISOString()), 10000);
</script>
</body>
</html>
