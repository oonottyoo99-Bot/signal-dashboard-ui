<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Signal Scanner Dashboard</title>

  <!-- (ทางเลือก) หากอยากกำหนดฐาน API ผ่าน meta ก็ใส่ content ตรงนี้ได้ -->
  <!-- <meta name="api-base" content="https://YOUR-API.vercel.app"> -->

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Sarabun',sans-serif;background-color:#0a0a0a;background-image:radial-gradient(circle at 1px 1px,#333 1px,transparent 0);background-size:25px 25px}
    .scan-button,.tab-button{transition:all .2s ease-in-out}
    .scan-button:disabled{cursor:not-allowed;filter:grayscale(80%);opacity:.5}
    .scan-button:not(:disabled):hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.2)}
    .loader{border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .gradient-text{background:linear-gradient(to right,#2dd4bf,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .custom-checkbox:checked{background-color:#2dd4bf;border-color:#2dd4bf}
    .link{color:#38bdf8}
  </style>
</head>
<body class="text-gray-200">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    /** ------------------------------
     * กำหนดแหล่งข้อมูล
     * - API_BASE จะพยายามอ่านจาก:
     *   1) URL param: ?api=... 
     *   2) <meta name="api-base" content="...">
     *   3) ค่า fallback (แก้ได้ด้านล่าง)
     * ------------------------------ */
    const DEFAULT_API_BASE = "https://minimal-vercel-ashy.vercel.app"; // แก้ตรงนี้ถ้าต้องการ
    const urlParams = new URLSearchParams(location.search);
    const PARAM_API_BASE = urlParams.get("api");
    const META_API_BASE = document.querySelector('meta[name="api-base"]')?.getAttribute('content') || "";
    const API_BASE = (PARAM_API_BASE || META_API_BASE || DEFAULT_API_BASE).replace(/\/+$/,"");

    // ไฟล์ข้อมูลบน GitHub (แก้ repo/ไฟล์ได้)
    const GITHUB_REPO_RAW_URL   = "https://raw.githubusercontent.com/oONOTTYOo99-Bot/oONOTTYOo99-Alert/main/signals.json";
    const GITHUB_SETTINGS_URL   = "https://raw.githubusercontent.com/oONOTTYOo99-Bot/oONOTTYOo99-Alert/main/settings.json";

    // กลุ่มที่ใช้สแกน (UI)
    const scanGroups = [
      { id:'sp500',     name:'S&P 500',        color:'blue'    },
      { id:'nasdaq100', name:'Nasdaq 100',     color:'indigo'  },
      { id:'altcoins',  name:'Altcoins (OKX)', color:'amber'   },
      { id:'binance',   name:'Binance Top 200',color:'yellow'  },
      { id:'okx',       name:'OKX Top 200',    color:'cyan'    },
      { id:'bitkub',    name:'Bitkub',         color:'green'   },
      { id:'set50',     name:'SET50',          color:'emerald' },
      { id:'set100',    name:'SET100',         color:'rose'    },
      { id:'etf',       name:'ETFs',           color:'teal'    },
      { id:'gold',      name:'ทองคำ',          color:'yellow'  },
    ];

    const colorClasses = {
      blue:'bg-blue-600 hover:bg-blue-500',
      indigo:'bg-indigo-600 hover:bg-indigo-500',
      teal:'bg-teal-600 hover:bg-teal-500',
      amber:'bg-amber-600 hover:bg-amber-500',
      emerald:'bg-emerald-600 hover:bg-emerald-500',
      rose:'bg-rose-600 hover:bg-rose-500',
      yellow:'bg-yellow-500 hover:bg-yellow-400',
      cyan:'bg-cyan-600 hover:bg-cyan-500',
      green:'bg-green-600 hover:bg-green-500'
    };

    function App(){
      const [signals, setSignals] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [scanningGroup, setScanningGroup] = useState(null);
      const [autoScanSelection, setAutoScanSelection] = useState({});
      const [isSaving, setIsSaving] = useState(false);
      const [health, setHealth] = useState(null);

      const api = useMemo(()=>({
        health:      () => fetch(`${API_BASE}/api/health`).then(r=>r.json()),
        runScan:     (group) => fetch(`${API_BASE}/run_scan?group=${encodeURIComponent(group)}`),
        saveSetting: (selected) => fetch(`${API_BASE}/save_settings`, {
                          method:'POST',
                          headers:{'Content-Type':'application/json'},
                          body: JSON.stringify({ auto_scan_groups: selected })
                        })
      }), []);

      const fetchSignals = useCallback(async () => {
        setLoading(true); setError(null);
        try{
          const res = await fetch(`${GITHUB_REPO_RAW_URL}?t=${Date.now()}`);
          if(!res.ok){
            if(res.status===404){
              setSignals({ last_updated:"ยังไม่มีข้อมูล", scan_group:"-", signals_found:[] });
              return;
            }
            throw new Error(`โหลดข้อมูลล้มเหลว: ${res.status} ${res.statusText}`);
          }
          setSignals(await res.json());
        }catch(err){ setError(err.message); }
        finally{ setLoading(false); }
      },[]);

      const fetchSettings = useCallback(async () => {
        try{
          const res = await fetch(`${GITHUB_SETTINGS_URL}?t=${Date.now()}`);
          if(!res.ok) return;
          const data = await res.json();
          const sel = {};
          (data.auto_scan_groups||[]).forEach(g => sel[g] = true);
          setAutoScanSelection(sel);
        }catch(_){ /* ignore */ }
      },[]);

      const checkHealth = useCallback(async () => {
        try{
          const h = await api.health();
          setHealth(h);
        }catch(_){
          setHealth({ ok:false });
        }
      },[]);

      useEffect(()=>{ 
        fetchSignals(); 
        fetchSettings(); 
        checkHealth();
      },[fetchSignals, fetchSettings, checkHealth]);

      const handleScan = async (groupId) => {
        setScanningGroup(groupId);
        try{
          await api.runScan(groupId);
          // รอ backend ประมวลผลแล้วค่อย refresh
          setTimeout(fetchSignals, 7000);
        }catch(err){
          alert(`สั่งสแกนไม่สำเร็จ: ${err.message}`);
        }finally{
          setTimeout(()=> setScanningGroup(null), 12000);
        }
      };

      const handleCheckboxChange = (groupId) => {
        setAutoScanSelection(prev => ({ ...prev, [groupId]: !prev[groupId] }));
      };

      const handleSaveSettings = async () => {
        setIsSaving(true);
        const selected = Object.keys(autoScanSelection).filter(k => autoScanSelection[k]);
        try{
          const r = await api.saveSetting(selected);
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          alert("บันทึกการตั้งค่าสำเร็จ");
        }catch(err){
          alert(`เกิดข้อผิดพลาด: ${err.message}`);
        }finally{
          setIsSaving(false);
        }
      };

      return (
        <div className="container mx-auto p-4 md:p-8 max-w-7xl">
          <header className="text-center mb-10">
            <h1 className="text-4xl md:text-5xl font-bold gradient-text">Signal Scanner Dashboard</h1>
            <p className="mt-2 text-sm text-gray-400">
              API Base: <span className="link">{API_BASE}</span>
              {health && <span className="ml-2 px-2 py-0.5 rounded text-xs" style={{background: health.ok ? "rgba(16,185,129,.2)" : "rgba(239,68,68,.2)", color: health.ok ? "#34d399" : "#f87171"}}>
                {health.ok ? "HEALTHY" : "UNHEALTHY"}
              </span>}
            </p>
            <p className="mt-1 text-xs text-gray-500">เปลี่ยนปลายทางชั่วคราวได้ด้วยพารามิเตอร์: <code>?api=https://your-api</code></p>
          </header>

          {/* บล็อกตั้งค่า Auto-Scan */}
          <div className="bg-gray-800/50 backdrop-blur-sm border border-gray-700 p-6 rounded-xl shadow-lg mb-8">
            <h2 className="text-2xl font-semibold mb-4 text-gray-100">ตั้งค่าสแกนอัตโนมัติ (Auto-Scan)</h2>
            <p className="text-gray-400 mb-4">เลือกกลุ่มที่ต้องการให้ระบบสแกนตามเวลาที่ตั้งค่าไว้ (เช่น Cron)</p>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-4">
              {scanGroups.map(group => (
                <label key={group.id} className="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-gray-700">
                  <input
                    type="checkbox"
                    className="custom-checkbox h-5 w-5 rounded bg-gray-600 border-gray-500 text-cyan-500 focus:ring-cyan-600"
                    checked={!!autoScanSelection[group.id]}
                    onChange={() => handleCheckboxChange(group.id)}
                  />
                  <span>{group.name}</span>
                </label>
              ))}
            </div>
            <button
              onClick={handleSaveSettings}
              disabled={isSaving}
              className="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg disabled:bg-gray-500"
            >
              {isSaving ? "กำลังบันทึก..." : "บันทึกการตั้งค่า"}
            </button>
          </div>

          {/* บล็อก Manual Scan */}
          <div className="bg-gray-800/50 backdrop-blur-sm border border-gray-700 p-6 rounded-xl shadow-lg mb-8">
            <h2 className="text-2xl font-semibold mb-4 text-gray-100">สั่งสแกนด้วยตนเอง (Manual Scan)</h2>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
              {scanGroups.map(group => (
                <button
                  key={group.id}
                  onClick={() => handleScan(group.id)}
                  disabled={!!scanningGroup}
                  className={`scan-button text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center ${colorClasses[group.color]}`}
                >
                  {scanningGroup === group.id
                    ? <div className="loader h-6 w-6 rounded-full border-2 border-t-2 border-gray-200/50"></div>
                    : <span>{group.name}</span>}
                </button>
              ))}
            </div>
            {scanningGroup && (
              <p className="text-center mt-4 text-amber-400 animate-pulse">
                กำลังสั่งสแกนกลุ่ม {scanningGroup}...
              </p>
            )}
          </div>

          {/* บล็อกผลล่าสุด */}
          <div className="bg-gray-800/50 backdrop-blur-sm border border-gray-700 p-6 rounded-xl shadow-lg">
            <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
              <h2 className="text-2xl font-semibold text-gray-100">ผลการสแกนล่าสุด</h2>
              <button
                onClick={fetchSignals}
                disabled={loading}
                className="bg-gray-700 p-2 rounded-full hover:bg-gray-600 disabled:opacity-50"
                title="รีเฟรชข้อมูล"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 ${loading ? 'animate-spin' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h5M20 20v-5h-5m0-6a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </button>
            </div>

            {signals && !loading && (
              <div className="text-gray-400 mb-4 text-center md:text-left">
                <p><strong>กลุ่มที่สแกนล่าสุด:</strong> <span className="font-semibold text-amber-400">{signals.scan_group}</span></p>
                <p><strong>อัปเดตเมื่อ:</strong> {signals.last_updated}</p>
              </div>
            )}

            {loading && !error && <p className="text-center py-8">กำลังโหลดข้อมูล...</p>}
            {error && <p className="text-center py-8 text-red-400">เกิดข้อผิดพลาด: {error}</p>}

            {signals && !loading && (
              <div className="overflow-x-auto">
                <table className="min-w-full bg-gray-900/50 rounded-lg">
                  <thead className="bg-gray-700/50">
                    <tr>
                      <th className="py-3 px-4 text-left font-semibold">Ticker</th>
                      <th className="py-3 px-4 text-left font-semibold">Signal</th>
                      <th className="py-3 px-4 text-left font-semibold">Price</th>
                      <th className="py-3 px-4 text-left font-semibold hidden md:table-cell">Timeframe</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Array.isArray(signals.signals_found) && signals.signals_found.length > 0 ? (
                      signals.signals_found.map((s, i) => (
                        <tr key={i} className="border-b border-gray-700 hover:bg-gray-700/50 transition-colors">
                          <td className="py-3 px-4 font-bold text-cyan-400">{s.ticker}</td>
                          <td className="py-3 px-4">
                            <span className={`px-2.5 py-1 rounded-full text-xs font-semibold ${s.signal === 'Strong Buy' ? 'bg-green-500/20 text-green-300' : 'bg-yellow-500/20 text-yellow-300'}`}>
                              {s.signal}
                            </span>
                          </td>
                          <td className="py-3 px-4">{s.price}</td>
                          <td className="py-3 px-4 hidden md:table-cell">{s.timeframe}</td>
                        </tr>
                      ))
                    ) : (
                      <tr><td colSpan="4" className="text-center py-10 text-gray-500">ไม่พบสัญญาณในรอบล่าสุด</td></tr>
                    )}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
